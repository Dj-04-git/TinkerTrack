---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

const session = Astro.locals?.session ?? {};
if (session.isLoggedIn) {
	return Astro.redirect(session.isAdmin ? '/admin/subscriptions' : '/shop');
}
---

<Layout title="TinkerTrack â€¢ Reset Password">
	<main>
		<section class="relative flex-1 overflow-hidden">
			<div class="pointer-events-none absolute inset-0">
				<div
					class="absolute -top-20 left-10 h-64 w-64 rounded-full bg-primary/25 blur-3xl"
				></div>
				<div
					class="absolute bottom-0 right-0 h-80 w-80 rounded-full bg-secondary/20 blur-3xl"
				></div>
			</div>

			<div class="mx-auto grid max-w-6xl gap-10 px-6 py-16 lg:grid-cols-2 lg:items-center">
				<div class="flex flex-col items-center text-center lg:items-start lg:text-left">
					<p class="badge badge-outline">Final Step</p>
					<h1 class="font-display mt-4 text-4xl font-semibold tracking-tight sm:text-5xl">
						Create your new password
					</h1>
					<p class="mt-4 text-base-content/70">
						Enter the OTP sent to your email and choose a new secure password
						to regain access to your TinkerTrack account.
					</p>
					<div class="mt-8 grid w-full gap-4 sm:max-w-md">
						<div class="flex items-center gap-3 text-sm text-base-content/70">
							<span class="badge badge-neutral">Secure</span>
							<span>Use a strong password with mixed characters.</span>
						</div>
						<div class="flex items-center gap-3 text-sm text-base-content/70">
							<span class="badge badge-neutral">Protected</span>
							<span>Your account security is our priority.</span>
						</div>
					</div>
				</div>

				<div class="mx-auto w-full max-w-md">
					<div class="card bg-base-200/70 shadow-2xl backdrop-blur">
						<div class="card-body">
							<h2 class="font-display text-2xl">Reset Password</h2>
							<p class="text-sm text-base-content/70">
								Enter the OTP sent to your email and your new password below.
							</p>

							<div class="alert alert-success text-sm hidden mt-4" id="successMessage">
								<span>Password reset successful! Redirecting...</span>
							</div>

							<form class="mt-6 grid gap-5" id="resetPasswordForm" novalidate>
								<!-- OTP Section -->
								<div class="form-control">
									<label class="label justify-center">
										<span class="label-text">Enter OTP</span>
									</label>
									<div class="flex gap-2 justify-center" id="otpContainer">
										<input class="input input-bordered w-12 h-12 text-center text-xl font-bold p-0" type="text" maxlength="1" inputmode="numeric" required>
										<input class="input input-bordered w-12 h-12 text-center text-xl font-bold p-0" type="text" maxlength="1" inputmode="numeric" required>
										<input class="input input-bordered w-12 h-12 text-center text-xl font-bold p-0" type="text" maxlength="1" inputmode="numeric" required>
										<input class="input input-bordered w-12 h-12 text-center text-xl font-bold p-0" type="text" maxlength="1" inputmode="numeric" required>
										<input class="input input-bordered w-12 h-12 text-center text-xl font-bold p-0" type="text" maxlength="1" inputmode="numeric" required>
										<input class="input input-bordered w-12 h-12 text-center text-xl font-bold p-0" type="text" maxlength="1" inputmode="numeric" required>
									</div>
									<p class="mt-2 text-xs text-error hidden text-center" id="otpError"></p>
								</div>

								<!-- Password Section -->
								<div class="divider">New Password</div>

								<div class="form-control">
									<label class="label">
										<span class="label-text">New Password</span>
									</label>
									<input
										type="password"
										id="newPassword"
										name="newPassword"
										placeholder="Enter your new password"
										class="input input-bordered w-full"
										required
										minlength="9"
									/>
									<p class="mt-2 text-xs text-error hidden" id="passwordError"></p>
									<p class="mt-2 text-xs text-base-content/60" id="passwordHint">
										Minimum 9 characters with uppercase, lowercase, and a special character.
									</p>
								</div>

								<div class="form-control">
									<label class="label">
										<span class="label-text">Confirm New Password</span>
									</label>
									<input
										type="password"
										id="confirmPassword"
										name="confirmPassword"
										placeholder="Confirm your new password"
										class="input input-bordered w-full"
										required
									/>
									<p class="mt-2 text-xs text-error hidden" id="confirmPasswordError"></p>
								</div>

								<button class="btn btn-primary" type="submit">Reset Password</button>
							</form>

							<p class="mt-4 text-sm text-base-content/70">
								<a class="link-hover" href="/login">Back to Login</a>
							</p>
						</div>
					</div>
				</div>
			</div>
		</section>
	</main>
</Layout>

<script>
	const resetPasswordForm = document.getElementById('resetPasswordForm') as HTMLFormElement;
	const successMessage = document.getElementById('successMessage') as HTMLDivElement;
	const otpInputs = document.querySelectorAll('#otpContainer input') as NodeListOf<HTMLInputElement>;
	const newPasswordInput = document.getElementById('newPassword') as HTMLInputElement;
	const confirmPasswordInput = document.getElementById('confirmPassword') as HTMLInputElement;
	
	const otpError = document.getElementById('otpError') as HTMLParagraphElement;
	const passwordError = document.getElementById('passwordError') as HTMLParagraphElement;
	const passwordHint = document.getElementById('passwordHint') as HTMLParagraphElement;
	const confirmPasswordError = document.getElementById('confirmPasswordError') as HTMLParagraphElement;

	// OTP Input Logic
	otpInputs.forEach((input, index) => {
		input.addEventListener('input', (e) => {
			const target = e.target as HTMLInputElement;
			if (target.value.length === 1) {
				if (index < otpInputs.length - 1) {
					otpInputs[index + 1].focus();
				}
			}
		});

		input.addEventListener('keydown', (e) => {
			const target = e.target as HTMLInputElement;
			if (e.key === 'Backspace' && !target.value) {
				if (index > 0) {
					otpInputs[index - 1].focus();
				}
			}
		});
		
		// Allow only numbers
		input.addEventListener('keypress', (e) => {
			if (!/[0-9]/.test(e.key)) {
				e.preventDefault();
			}
		});
	});

	function showOtpError(message: string) {
		otpInputs.forEach(input => input.classList.add('input-error'));
		otpError.classList.remove('hidden');
		otpError.textContent = message;
	}

	function showPasswordError(message: string) {
		newPasswordInput.classList.add('input-error');
		passwordError.classList.remove('hidden');
		passwordError.textContent = message;
		passwordHint.classList.add('hidden');
	}

	function showConfirmPasswordError(message: string) {
		confirmPasswordInput.classList.add('input-error');
		confirmPasswordError.classList.remove('hidden');
		confirmPasswordError.textContent = message;
	}

	function clearErrors() {
		otpInputs.forEach(input => input.classList.remove('input-error'));
		newPasswordInput.classList.remove('input-error');
		confirmPasswordInput.classList.remove('input-error');
		
		otpError.classList.add('hidden');
		passwordError.classList.add('hidden');
		confirmPasswordError.classList.add('hidden');
		passwordHint.classList.remove('hidden');
		
		successMessage.classList.add('hidden');
	}

	// Check if email exists in session storage
	const email = sessionStorage.getItem('resetEmail');
	if (!email) {
		window.location.href = '/forgot-password';
	}

	resetPasswordForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		clearErrors();

		const storedEmail = sessionStorage.getItem('resetEmail');
		if (!storedEmail) {
			showOtpError('Session expired. Please try again.');
			setTimeout(() => window.location.href = '/forgot-password', 2000);
			return;
		}

		let otp = '';
		otpInputs.forEach(input => otp += input.value);

		const newPassword = newPasswordInput.value;
		const confirmPassword = confirmPasswordInput.value;

		let hasError = false;

		if (otp.length !== 6) {
			showOtpError('Please enter a valid 6-digit OTP');
			hasError = true;
		}

		const hasUppercase = /[A-Z]/.test(newPassword);
		const hasLowercase = /[a-z]/.test(newPassword);
		const hasSpecial = /[^A-Za-z0-9]/.test(newPassword);

		if (newPassword.length < 9) {
			showPasswordError('Password must be at least 9 characters');
			hasError = true;
		} else if (!hasUppercase || !hasLowercase || !hasSpecial) {
			showPasswordError('Password must include uppercase, lowercase, and a special character.');
			hasError = true;
		}

		if (newPassword !== confirmPassword) {
			showConfirmPasswordError('Passwords do not match');
			hasError = true;
		}

		if (hasError) return;

		try {
			const response = await fetch('/api/auth/reset-password', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ email: storedEmail, otp, newPassword }),
			});

			const data = await response.json();

			if (response.ok) {
				successMessage.classList.remove('hidden');
				successMessage.textContent = 'Password reset successful! Redirecting to login...';
				sessionStorage.removeItem('resetEmail');
				setTimeout(() => {
					window.location.href = '/login';
				}, 2000);
			} else {
				const errorMsg = data.message || data.error || 'Reset failed';
				if (errorMsg.toLowerCase().includes('otp')) {
					showOtpError(errorMsg);
				} else {
					showPasswordError(errorMsg);
				}
			}
		} catch (error) {
			console.error('Error:', error);
			showOtpError('An error occurred. Please try again.');
		}
	});
</script>
