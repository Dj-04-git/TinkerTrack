---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';
import PageHeader from '../../components/PageHeader.astro';
import AddressCard from '../../components/AddressCard.astro';
import OrderItemsTable from '../../components/OrderItemsTable.astro';
import AccessGate from '../../components/AccessGate.astro';
import { getAddresses } from '../../lib/checkout.js';

const session = Astro.locals?.session ?? {};
const isLoggedIn = Boolean(session.isLoggedIn);
const isAdmin = Boolean(session.isAdmin);

const orderId = Astro.params.id;

// Fetch order from backend API
let activeOrder = null;
let error = null;

try {
	const response = await fetch(`http://localhost:3000/subscriptions/${orderId}`);
	if (response.ok) {
		const subscription = await response.json();
		// Transform subscription to order format
		const addresses = getAddresses();
		activeOrder = {
			id: subscription.subscriptionNumber,
			date: new Date(subscription.createdAt).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }),
			total: subscription.total,
			status: subscription.status,
			subscription: subscription.items?.[0]?.productName || 'Subscription',
			plan: subscription.paymentTerms || 'Standard',
			startDate: subscription.startDate ? new Date(subscription.startDate).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }) : '-',
			endDate: subscription.endDate ? new Date(subscription.endDate).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }) : '-',
			billingAddress: addresses[0],
			invoices: [
				{
					number: `INV-${subscription.id?.toString().padStart(4, '0') || '0001'}`,
					status: subscription.status === 'Paid' ? 'Paid' : 'Awaiting',
					amount: subscription.total?.toFixed(2),
					invoiceDate: new Date(subscription.createdAt).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }),
					dueDate: new Date(subscription.createdAt).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }),
					source: 'Checkout',
					paymentTerm: subscription.paymentTerms || 'Immediate payment',
					paidOn: subscription.status === 'Paid' ? new Date(subscription.createdAt).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' }) : null,
					amountDue: subscription.status === 'Paid' ? 0 : subscription.total
				}
			],
			items: [
				...(subscription.items || []).map(item => ({
					name: item.productName,
					quantity: item.quantity,
					unitPrice: item.unitPrice?.toFixed(2),
					tax: '10%',
					amount: item.amount?.toFixed(2)
				})),
				...(subscription.discountAmount > 0 ? [{
					name: subscription.discountCode ? `Discount (${subscription.discountCode})` : 'Discount',
					quantity: 1,
					unitPrice: (-subscription.discountAmount)?.toFixed(2),
					tax: '—',
					amount: (-subscription.discountAmount)?.toFixed(2)
				}] : [])
			],
			summary: {
				subtotal: subscription.subtotal?.toFixed(2),
				taxes: subscription.tax?.toFixed(2),
				total: subscription.total?.toFixed(2)
			}
		};
	} else {
		error = 'Failed to load order details';
	}
} catch (e) {
	error = 'Unable to connect to the server';
}
---

<Layout title={`TinkerTrack • ${activeOrder?.id ?? 'Order'}`} isLoggedIn={isLoggedIn} isAdmin={isAdmin}>
	{
		isLoggedIn ? (
			<section class="relative overflow-hidden">
				<div class="mx-auto max-w-6xl px-6 py-16">
					<PageHeader
						badge="Order details"
						title={`Order ${activeOrder?.id ?? 'Not found'}`}
						description="View subscription status, invoices, and totals at a glance."
					>
						<div slot="actions">
							<button class="btn btn-outline btn-sm">Download PDF</button>
							<button class="btn btn-outline btn-sm">Renew</button>
							<a class="btn btn-ghost btn-sm" href="/orders">Close</a>
						</div>
					</PageHeader>

					{error && (
						<div class="mt-6 alert alert-warning">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
							</svg>
							<span>{error}</span>
						</div>
					)}

					{activeOrder ? (
						<div class="mt-10 grid gap-8 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)]">
							<div class="grid gap-6">
								<div class="card bg-base-200/70 shadow-xl backdrop-blur">
									<div class="card-body gap-4">
										<div class="flex flex-wrap items-center justify-between gap-3">
											<div>
												<h2 class="font-display text-2xl">Your subscription</h2>
												<p class="text-sm text-base-content/70">{activeOrder.subscription}</p>
											</div>
											<span class={`badge badge-outline ${activeOrder.status === 'Paid' ? 'badge-success' : activeOrder.status === 'Pending' ? 'badge-warning' : ''}`}>{activeOrder.status}</span>
										</div>
										<div class="grid gap-3 text-sm text-base-content/70">
											<div class="flex items-center justify-between">
												<span>Plan</span>
												<span class="font-medium text-base-content">{activeOrder.plan}</span>
											</div>
											<div class="flex items-center justify-between">
												<span>Start date</span>
												<span class="font-medium text-base-content">{activeOrder.startDate}</span>
											</div>
											<div class="flex items-center justify-between">
												<span>End date</span>
												<span class="font-medium text-base-content">{activeOrder.endDate}</span>
											</div>
										</div>
										<div class="rounded-2xl border border-base-300/70 bg-base-100/70 p-4">
											<p class="text-xs uppercase tracking-widest text-base-content/60">Last invoices</p>
											<div class="mt-3 grid gap-2 text-sm">
												{activeOrder.invoices.map((invoice) => (
													<a
														class="flex items-center justify-between rounded-xl p-2 transition hover:bg-base-200/70"
														href={`/orders/${activeOrder.id}/invoice/${invoice.number}`}
													>
														<span>{invoice.number}</span>
														<span class={`badge badge-outline ${invoice.status === 'Paid' ? 'badge-success' : 'badge-warning'}`}>{invoice.status}</span>
														<span class="font-medium">${invoice.amount}</span>
													</a>
												))}
											</div>
										</div>
									</div>
								</div>

								<AddressCard address={activeOrder.billingAddress} />
							</div>

							<OrderItemsTable items={activeOrder.items}>
								<div class="mt-4 grid gap-2 text-sm text-base-content/70">
									<div class="flex items-center justify-between">
										<span>Subtotal</span>
										<span>${activeOrder.summary.subtotal}</span>
									</div>
									<div class="flex items-center justify-between">
										<span>Taxes</span>
										<span>${activeOrder.summary.taxes}</span>
									</div>
									<div class="flex items-center justify-between border-t border-base-300/70 pt-3 text-base-content">
										<span>Total</span>
										<span class="font-semibold">${activeOrder.summary.total}</span>
									</div>
								</div>
							</OrderItemsTable>
						</div>
					) : (
						<div class="mt-10 card bg-base-200/70 shadow-xl backdrop-blur">
							<div class="card-body">
								<h2 class="font-display text-2xl">Order not found</h2>
								<p class="text-base-content/70">Return to your order list to select another order.</p>
								<a class="btn btn-primary" href="/orders">Back to orders</a>
							</div>
						</div>
					)}
				</div>
			</section>
		) : (
			<AccessGate
				badge="Login required"
				title="Sign in to view order details"
				description="This page includes invoices and billing data tied to your workspace."
			/>
		)
	}
</Layout>
