---
export const prerender = false;
import Layout from '../layouts/Layout.astro';

const session = Astro.locals?.session ?? {};
if (session.isLoggedIn) {
	return Astro.redirect(session.isAdmin ? '/admin/subscriptions' : '/shop');
}
---

<Layout title="TinkerTrack â€¢ Forgot Password">
	<main>
		<section class="relative flex-1 overflow-hidden">
			<div class="pointer-events-none absolute inset-0">
				<div
					class="absolute -top-20 left-10 h-64 w-64 rounded-full bg-primary/25 blur-3xl"
				></div>
				<div
					class="absolute bottom-0 right-0 h-80 w-80 rounded-full bg-secondary/20 blur-3xl"
				></div>
			</div>

			<div class="mx-auto grid max-w-6xl gap-10 px-6 py-16 lg:grid-cols-2 lg:items-center">
				<div class="flex flex-col items-center text-center lg:items-start lg:text-left">
					<p class="badge badge-outline">Password Recovery</p>
					<h1 class="font-display mt-4 text-4xl font-semibold tracking-tight sm:text-5xl">
						Reset your password
					</h1>
					<p class="mt-4 text-base-content/70">
						Enter your registered email address and we'll send you a one-time password
						to help you regain access to your account.
					</p>
					<div class="mt-8 grid w-full gap-4 sm:max-w-md">
						<div class="flex items-center gap-3 text-sm text-base-content/70">
							<span class="badge badge-neutral">Secure</span>
							<span>OTP expires after a short period for your safety.</span>
						</div>
						<div class="flex items-center gap-3 text-sm text-base-content/70">
							<span class="badge badge-neutral">Quick</span>
							<span>Reset your password in just a few steps.</span>
						</div>
					</div>
				</div>

				<div class="mx-auto w-full max-w-md">
					<div class="card bg-base-200/70 shadow-2xl backdrop-blur">
						<div class="card-body">
							<h2 class="font-display text-2xl">Forgot Password</h2>
							<p class="text-sm text-base-content/70">
								Enter your email address and we'll send you an OTP to reset your password.
							</p>

							<div class="alert alert-success text-sm hidden mt-4" id="successMessage">
								<span>OTP sent to your email! Redirecting...</span>
							</div>

							<form class="mt-6 grid gap-5" id="forgotPasswordForm" novalidate>
								<div class="form-control">
									<label class="label">
										<span class="label-text">Email address</span>
									</label>
									<input
										type="email"
										id="email"
										name="email"
										placeholder="you@track.app"
										class="input input-bordered w-full"
										required
									/>
									<p class="mt-2 text-xs text-error hidden" id="emailError"></p>
								</div>
								<button class="btn btn-primary" type="submit">Send Reset OTP</button>
							</form>

							<p class="mt-4 text-sm text-base-content/70">
								Remember your password? <a class="link-hover" href="/login">Sign in</a>
							</p>
						</div>
					</div>
				</div>
			</div>
		</section>
	</main>
</Layout>

<script>
	const forgotPasswordForm = document.getElementById('forgotPasswordForm') as HTMLFormElement;
	const successMessage = document.getElementById('successMessage') as HTMLDivElement;
	const emailInput = document.getElementById('email') as HTMLInputElement;
	const emailError = document.getElementById('emailError') as HTMLParagraphElement;

	function showError(message: string) {
		emailInput.classList.add('input-error');
		emailError.classList.remove('hidden');
		emailError.textContent = message;
	}

	function clearErrors() {
		emailInput.classList.remove('input-error');
		emailError.classList.add('hidden');
		successMessage.classList.add('hidden');
	}

	forgotPasswordForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		clearErrors();

		const email = emailInput.value.trim();

		if (!email) {
			showError('Email is required.');
			return;
		}

		const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
		if (!emailRegex.test(email)) {
			showError('Enter a valid email address.');
			return;
		}

		try {
			const response = await fetch('/api/auth/forgot-password', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ email }),
			});

			const data = await response.json();

			if (response.ok) {
				successMessage.classList.remove('hidden');
				successMessage.textContent = 'OTP sent to your email! Redirecting...';
				sessionStorage.setItem('resetEmail', email);
				setTimeout(() => {
					window.location.href = '/reset-password';
				}, 2000);
			} else {
				showError(data.message || data.error || 'Email not found');
			}
		} catch (error) {
			console.error('Error:', error);
			showError('An error occurred. Please try again.');
		}
	});
</script>
