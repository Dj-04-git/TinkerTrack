---
export const prerender = false;
import AdminLayout from '../../../layouts/AdminLayout.astro';
import AccessGate from '../../../components/AccessGate.astro';
import AdminPageHeader from '../../../components/admin/AdminPageHeader.astro';

const session = Astro.locals?.session ?? {};
const isLoggedIn = Boolean(session.isLoggedIn);
const isAdmin = Boolean(session.isAdmin);

// Get product ID from URL
const { id } = Astro.params;

// Fetch product from API
let product: any = null;
let recurringPrices: any[] = [];
let variants: any[] = [];
let availablePlans: any[] = [];
let error: string | null = null;

if (isLoggedIn && isAdmin && id) {
	try {
		// Fetch product with plans and variants
		const response = await fetch(`http://localhost:3000/products/${id}`);
		if (response.ok) {
			const data = await response.json();
			product = {
				id: data.id,
				name: data.productName,
				type: data.productType || 'Service',
				salesPrice: data.salesPrice || 0,
				costPrice: data.costPrice || 0,
				tax: data.tax || 0
			};
			
			// Transform variants
			variants = (data.variants || []).map((v: any) => ({
				id: v.id,
				attribute: v.attribute,
				value: v.value,
				extraPrice: v.extraPrice || 0
			}));
			
			// Transform plans to recurring prices
			recurringPrices = (data.plans || []).map((p: any) => ({
				id: p.id,
				plan: p.planName,
				price: p.price || 0,
				minQty: p.minQuantity || 1,
				billingPeriod: p.billingPeriod
			}));
		} else if (response.status === 404) {
			product = null;
		} else {
			error = 'Failed to load product';
		}

		// Fetch all available recurring plans
		const plansResponse = await fetch('http://localhost:3000/recurring-plans');
		if (plansResponse.ok) {
			availablePlans = await plansResponse.json();
		}
	} catch (e) {
		error = 'Unable to connect to the server';
		console.error('Product fetch error:', e);
	}
}
---

<AdminLayout title={product ? `TinkerTrack • ${product.name}` : 'TinkerTrack • Product Not Found'} isLoggedIn={isLoggedIn} activeTab="Products">
	{
		!isLoggedIn ? (
			<AccessGate
				badge="Login required"
				title="Sign in to view products"
				description="Admin product pages are available after you sign in."
			/>
		) : !isAdmin ? (
			<AccessGate
				badge="Admin only"
				title="Admin access required"
				description="Only admins can view product details."
				linkHref="/profile"
				linkText="Go to profile"
				hint="Request admin access from your workspace owner."
			/>
		) : !product ? (
			<div class="p-6 lg:p-8">
				<div class="flex flex-col items-center justify-center py-16 text-center">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-base-content/20 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
						<path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
					</svg>
					<h1 class="font-display text-2xl font-semibold mb-2">Product not found</h1>
					<p class="text-base-content/60 mb-6">The product you're looking for doesn't exist or has been removed.</p>
					<a href="/admin/products" class="btn btn-primary btn-sm">Back to products</a>
				</div>
			</div>
		) : (
			<div class="p-6 lg:p-8" x-data="productPage()">
				<AdminPageHeader eyebrow="Product details" title={product.name}>
					<Fragment slot="lead">
						<a href="/admin/products" class="btn btn-ghost btn-xs">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
							</svg>
							Back to products
						</a>
					</Fragment>
					<Fragment slot="actions">
						<button class="btn btn-ghost btn-sm text-error">Delete</button>
						<button class="btn btn-primary btn-sm">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
							</svg>
							Save changes
						</button>
					</Fragment>
				</AdminPageHeader>

				<div class="max-w-4xl grid gap-6">
					<!-- Product details form -->
					<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden">
						<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40">
							<h3 class="font-display text-lg">Product information</h3>
							<p class="text-xs text-base-content/60 mt-0.5">Basic details and pricing</p>
						</div>
						<div class="p-5 grid gap-5">
							<!-- Product Name -->
							<label class="form-control w-full">
								<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Product Name</span>
								<input
									type="text"
									value={product.name}
									class="input input-bordered bg-base-100/80"
								/>
							</label>

							<div class="grid gap-5 sm:grid-cols-2">
								<!-- Product Type -->
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Product Type</span>
									<select class="select select-bordered bg-base-100/80">
										<option selected={product.type === 'Service'}>Service</option>
										<option selected={product.type === 'Goods'}>Goods</option>
									</select>
								</label>

								<!-- Tax -->
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Tax</span>
									<select class="select select-bordered bg-base-100/80">
										<option selected={product.tax === 'None'}>None</option>
										<option selected={product.tax === 'GST 5%'}>GST 5%</option>
										<option selected={product.tax === 'GST 12%'}>GST 12%</option>
										<option selected={product.tax === 'GST 18%'}>GST 18%</option>
									</select>
								</label>
							</div>

							<div class="grid gap-5 sm:grid-cols-2">
								<!-- Sales Price -->
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Sales Price</span>
									<div class="input input-bordered bg-base-100/80 flex items-center">
										<span class="text-base-content/50">$</span>
										<input
											type="number"
											step="0.01"
											value={product.salesPrice}
											class="grow bg-transparent border-0 focus:outline-none pl-1 number-input"
										/>
									</div>
								</label>

								<!-- Cost Price -->
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Cost Price</span>
									<div class="input input-bordered bg-base-100/80 flex items-center">
										<span class="text-base-content/50">$</span>
										<input
											type="number"
											step="0.01"
											value={product.costPrice}
											class="grow bg-transparent border-0 focus:outline-none pl-1 number-input"
										/>
									</div>
								</label>
							</div>
						</div>
					</div>

					<!-- Recurring Prices / Variants tabbed container -->
					<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden" x-data="{ activeTab: 'recurring' }">
						<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40 flex items-center justify-between gap-4">
							<div class="flex items-center gap-2">
								<button
									class="btn btn-sm transition-all"
									:class="activeTab === 'recurring' ? 'btn-primary' : 'btn-ghost'"
									@click="activeTab = 'recurring'"
								>
									Recurring Prices
								</button>
								<button
									class="btn btn-sm transition-all"
									:class="activeTab === 'variants' ? 'btn-primary' : 'btn-ghost'"
									@click="activeTab = 'variants'"
								>
									Variants
								</button>
							</div>
						</div>

						<!-- Recurring Prices Tab -->
						<div x-show="activeTab === 'recurring'" x-transition:enter="transition ease-out duration-150" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
							<div class="overflow-x-auto">
								<table class="table">
									<thead>
										<tr class="text-xs uppercase tracking-widest text-base-content/50 border-b border-base-300/60">
											<th class="font-medium">Recurring Plan</th>
											<th class="font-medium">Price</th>
											<th class="font-medium">Billing Period</th>
											<th class="w-20"></th>
										</tr>
									</thead>
									<tbody>
										<template x-if="recurringPrices.length > 0">
											<template x-for="price in recurringPrices" :key="price.id">
												<tr class="hover:bg-base-200/40 transition-colors border-b border-base-300/40">
													<td class="font-medium" x-text="price.plan"></td>
													<td x-text="'$' + price.price.toFixed(2)"></td>
													<td><span class="badge badge-sm badge-ghost capitalize" x-text="price.billingPeriod"></span></td>
													<td>
														<button class="btn btn-ghost btn-xs text-error" @click="removePriceTier(price.id)">Remove</button>
													</td>
												</tr>
											</template>
										</template>
										<template x-if="recurringPrices.length === 0">
											<tr>
												<td colspan="4" class="text-center py-8 text-base-content/50">
													<div class="flex flex-col items-center gap-2">
														<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
															<path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
														</svg>
														<p>No recurring prices configured</p>
													</div>
												</td>
											</tr>
										</template>
									</tbody>
								</table>
							</div>
							<div class="px-5 py-3 border-t border-base-300/60 bg-base-100/40 flex items-center justify-between">
								<span class="text-xs text-base-content/50" x-text="recurringPrices.length + ' price tiers'"></span>
								<button class="btn btn-ghost btn-sm text-primary" @click="openAddPlanModal()">
									<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
										<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
									</svg>
									Add price tier
								</button>
							</div>
						</div>

						<!-- Variants Tab -->
						<div x-show="activeTab === 'variants'" x-cloak x-transition:enter="transition ease-out duration-150" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
							<div class="overflow-x-auto">
								<table class="table">
									<thead>
										<tr class="text-xs uppercase tracking-widest text-base-content/50 border-b border-base-300/60">
											<th class="font-medium">Attribute</th>
											<th class="font-medium">Value</th>
											<th class="font-medium">Extra Price</th>
											<th class="w-20"></th>
										</tr>
									</thead>
									<tbody>
										<template x-if="variants.length > 0">
											<template x-for="variant in variants" :key="variant.id">
												<tr class="hover:bg-base-200/40 transition-colors border-b border-base-300/40">
													<td class="font-medium" x-text="variant.attribute"></td>
													<td x-text="variant.value"></td>
													<td x-text="variant.extraPrice > 0 ? '+$' + variant.extraPrice.toFixed(2) : '—'"></td>
													<td>
														<button class="btn btn-ghost btn-xs text-error" @click="removeVariant(variant.id)">Remove</button>
													</td>
												</tr>
											</template>
										</template>
										<template x-if="variants.length === 0">
											<tr>
												<td colspan="4" class="text-center py-8 text-base-content/50">
													<div class="flex flex-col items-center gap-2">
														<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
															<path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
														</svg>
														<p>No variants configured</p>
													</div>
												</td>
											</tr>
										</template>
									</tbody>
								</table>
							</div>
							<div class="px-5 py-3 border-t border-base-300/60 bg-base-100/40 flex items-center justify-between">
								<span class="text-xs text-base-content/50" x-text="variants.length + ' variants'"></span>
								<button class="btn btn-ghost btn-sm text-primary" @click="openAddVariantModal()">
									<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
										<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
									</svg>
									Add variant
								</button>
							</div>
						</div>
					</div>

					<!-- Tip about configuration -->
					<div class="rounded-xl border border-info/30 bg-info/5 p-4 flex items-start gap-3">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-info flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
							<path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
						</svg>
						<div>
							<p class="text-sm font-medium text-info">Recurring plans</p>
							<p class="text-xs text-base-content/60 mt-1">
								To create new recurring plans, go to <a href="/admin/config/recurring-plan" class="link link-primary">Configuration → Recurring Plan</a>. 
								Attributes can be managed from <a href="/admin/config/attribute" class="link link-primary">Configuration → Attribute</a>.
							</p>
						</div>
					</div>
				</div>

				<!-- Add Price Tier Modal -->
				<dialog id="addPlanModal" class="modal">
					<div class="modal-box">
						<form method="dialog">
							<button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
						</form>
						<h3 class="font-display text-lg font-semibold mb-4">Add Price Tier</h3>
						<p class="text-sm text-base-content/60 mb-4">Select a recurring plan to add to this product.</p>
						
						<template x-if="getAvailablePlansForAdd().length > 0">
							<div class="form-control">
								<label class="label">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Recurring Plan</span>
								</label>
								<select class="select select-bordered w-full" x-model="selectedPlanId">
									<option value="">Select a plan...</option>
									<template x-for="plan in getAvailablePlansForAdd()" :key="plan.id">
										<option :value="plan.id" x-text="plan.planName + ' - $' + plan.price.toFixed(2) + '/' + plan.billingPeriod"></option>
									</template>
								</select>
							</div>
						</template>
						<template x-if="getAvailablePlansForAdd().length === 0">
							<div class="alert alert-warning">
								<svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
								<div>
									<span class="font-medium">No plans available</span>
									<p class="text-xs">All plans are already assigned or no plans exist. Create new plans in Configuration.</p>
								</div>
							</div>
						</template>

						<div class="modal-action">
							<form method="dialog">
								<button class="btn btn-ghost">Cancel</button>
							</form>
							<button 
								class="btn btn-primary" 
								:disabled="!selectedPlanId || loading"
								@click="addPriceTier()"
							>
								<span x-show="loading" class="loading loading-spinner loading-sm"></span>
								Add Plan
							</button>
						</div>
					</div>
					<form method="dialog" class="modal-backdrop">
						<button>close</button>
					</form>
				</dialog>

				<!-- Add Variant Modal -->
				<dialog id="addVariantModal" class="modal">
					<div class="modal-box">
						<form method="dialog">
							<button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
						</form>
						<h3 class="font-display text-lg font-semibold mb-4">Add Variant</h3>
						<p class="text-sm text-base-content/60 mb-4">Add a new variant attribute for this product.</p>
						
						<div class="space-y-4">
							<div class="form-control">
								<label class="label">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Attribute</span>
								</label>
								<input 
									type="text" 
									class="input input-bordered w-full" 
									placeholder="e.g., Size, Color, Material"
									x-model="newVariant.attribute"
								/>
							</div>
							<div class="form-control">
								<label class="label">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Value</span>
								</label>
								<input 
									type="text" 
									class="input input-bordered w-full" 
									placeholder="e.g., Large, Red, Cotton"
									x-model="newVariant.value"
								/>
							</div>
							<div class="form-control">
								<label class="label">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Extra Price</span>
								</label>
								<div class="input input-bordered flex items-center">
									<span class="text-base-content/50">$</span>
									<input 
										type="number" 
										step="0.01"
										class="grow bg-transparent border-0 focus:outline-none pl-1"
										placeholder="0.00"
										x-model="newVariant.extraPrice"
									/>
								</div>
								<label class="label">
									<span class="label-text-alt text-base-content/50">Additional cost for this variant (optional)</span>
								</label>
							</div>
						</div>

						<template x-if="variantError">
							<div class="alert alert-error mt-4">
								<svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
								<span x-text="variantError"></span>
							</div>
						</template>

						<div class="modal-action">
							<form method="dialog">
								<button class="btn btn-ghost" @click="resetVariantForm()">Cancel</button>
							</form>
							<button 
								class="btn btn-primary" 
								:disabled="!newVariant.attribute || !newVariant.value || loading"
								@click="addVariant()"
							>
								<span x-show="loading" class="loading loading-spinner loading-sm"></span>
								Add Variant
							</button>
						</div>
					</div>
					<form method="dialog" class="modal-backdrop">
						<button>close</button>
					</form>
				</dialog>
			</div>
		)
	}
</AdminLayout>

<script define:vars={{ id, recurringPrices, variants, availablePlans }}>
	window.productId = id;
	window.initialRecurringPrices = recurringPrices;
	window.initialVariants = variants;
	window.initialAvailablePlans = availablePlans;

	// Define productPage before Alpine loads
	document.addEventListener('alpine:init', () => {
		Alpine.data('productPage', () => ({
			productId: window.productId,
			recurringPrices: window.initialRecurringPrices || [],
			variants: window.initialVariants || [],
			availablePlans: window.initialAvailablePlans || [],
			selectedPlanId: '',
			newVariant: {
				attribute: '',
				value: '',
				extraPrice: 0
			},
			loading: false,
			variantError: '',

			getAvailablePlansForAdd() {
				const assignedPlanIds = this.recurringPrices.map(p => p.id);
				return this.availablePlans.filter(p => !assignedPlanIds.includes(p.id));
			},

			openAddPlanModal() {
				this.selectedPlanId = '';
				const modal = document.getElementById('addPlanModal');
				modal?.showModal();
			},

			openAddVariantModal() {
				this.resetVariantForm();
				const modal = document.getElementById('addVariantModal');
				modal?.showModal();
			},

			resetVariantForm() {
				this.newVariant = { attribute: '', value: '', extraPrice: 0 };
				this.variantError = '';
			},

			async addPriceTier() {
				if (!this.selectedPlanId) return;
				
				this.loading = true;
				try {
					const response = await fetch(`http://localhost:3000/products/${this.productId}/plans`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ planId: parseInt(this.selectedPlanId) })
					});

					if (response.ok) {
						const data = await response.json();
						this.recurringPrices.push({
							id: data.plan.id,
							plan: data.plan.planName,
							price: data.plan.price,
							billingPeriod: data.plan.billingPeriod
						});
						
						const modal = document.getElementById('addPlanModal');
						modal?.close();
					} else {
						const err = await response.json();
						alert(err.error || 'Failed to add plan');
					}
				} catch (e) {
					alert('Failed to connect to server');
				}
				this.loading = false;
			},

			async removePriceTier(planId) {
				if (!confirm('Remove this price tier from the product?')) return;
				
				try {
					const response = await fetch(`http://localhost:3000/products/${this.productId}/plans/${planId}`, {
						method: 'DELETE'
					});

					if (response.ok) {
						this.recurringPrices = this.recurringPrices.filter(p => p.id !== planId);
					} else {
						const err = await response.json();
						alert(err.error || 'Failed to remove plan');
					}
				} catch (e) {
					alert('Failed to connect to server');
				}
			},

			async addVariant() {
				if (!this.newVariant.attribute || !this.newVariant.value) return;
				
				this.loading = true;
				this.variantError = '';
				
				try {
					const response = await fetch(`http://localhost:3000/products/${this.productId}/variants`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							attribute: this.newVariant.attribute,
							value: this.newVariant.value,
							extraPrice: parseFloat(this.newVariant.extraPrice) || 0
						})
					});

					if (response.ok) {
						const data = await response.json();
						this.variants.push({
							id: data.id,
							attribute: data.attribute,
							value: data.value,
							extraPrice: data.extraPrice || 0
						});
						
						const modal = document.getElementById('addVariantModal');
						modal?.close();
						this.resetVariantForm();
					} else {
						const err = await response.json();
						this.variantError = err.error || 'Failed to add variant';
					}
				} catch (e) {
					this.variantError = 'Failed to connect to server';
				}
				this.loading = false;
			},

			async removeVariant(variantId) {
				if (!confirm('Remove this variant from the product?')) return;
				
				try {
					const response = await fetch(`http://localhost:3000/products/${this.productId}/variants/${variantId}`, {
						method: 'DELETE'
					});

					if (response.ok) {
						this.variants = this.variants.filter(v => v.id !== variantId);
					} else {
						const err = await response.json();
						alert(err.error || 'Failed to remove variant');
					}
				} catch (e) {
					alert('Failed to connect to server');
				}
			}
		}));
	});
</script>

<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<style>
	[x-cloak] { display: none !important; }
</style>
