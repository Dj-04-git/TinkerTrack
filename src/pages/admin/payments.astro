---
export const prerender = false;
import AdminLayout from '../../layouts/AdminLayout.astro';
import AccessGate from '../../components/AccessGate.astro';
import AdminPageHeader from '../../components/admin/AdminPageHeader.astro';

const session = Astro.locals?.session ?? {};
const isLoggedIn = Boolean(session.isLoggedIn);
const isAdmin = Boolean(session.isAdmin);

const paymentMethods = ['CASH', 'CARD', 'BANK_TRANSFER', 'UPI', 'WALLET'];

// Fetch payments from API
let paymentRecords: any[] = [];
let error: string | null = null;

if (isLoggedIn && isAdmin) {
	try {
		const response = await fetch('http://localhost:3000/payments');
		if (response.ok) {
			paymentRecords = await response.json();
		} else {
			const data = await response.json();
			error = data.error || 'Failed to load payments';
		}
	} catch (e) {
		error = 'Unable to connect to the server';
		console.error('Payments fetch error:', e);
	}
}
---

<AdminLayout title="TinkerTrack â€¢ Payments" isLoggedIn={isLoggedIn} activeSubTab="Payments">
	{
		!isLoggedIn ? (
			<AccessGate
				badge="Login required"
				title="Sign in to manage payments"
				description="Admin payment pages are available after you sign in."
			/>
		) : !isAdmin ? (
			<AccessGate
				badge="Admin only"
				title="Admin access required"
				description="Only admins can manage payment records."
				linkHref="/profile"
				linkText="Go to profile"
				hint="Request admin access from your workspace owner."
			/>
		) : (
			<div class="p-6 lg:p-8">
				<AdminPageHeader eyebrow="Configuration" title="Payments" description="Tracks paid and outstanding invoices">
					<Fragment slot="actions">
						<button class="btn btn-outline btn-sm">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
							</svg>
							New Payment
						</button>
						<span class="badge badge-info badge-sm">Invoice settlement</span>
					</Fragment>
				</AdminPageHeader>

				<div class="max-w-4xl grid gap-6">
					<!-- Payment entry form -->
					<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden">
						<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40">
							<h3 class="font-display text-lg">Record a Payment</h3>
							<p class="text-xs text-base-content/60 mt-0.5">Log payments for invoice settlement</p>
						</div>
						<div class="p-5 grid gap-5 sm:grid-cols-2">
							<label class="form-control">
								<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Payment Method</span>
								<select class="select select-bordered bg-base-100/80">
									{paymentMethods.map((method) => (
										<option>{method}</option>
									))}
								</select>
							</label>
							<label class="form-control">
								<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Amount</span>
								<div class="input input-bordered bg-base-100/80 flex items-center">
									<span class="text-base-content/50">$</span>
									<input type="number" step="0.01" placeholder="0.00" class="grow bg-transparent border-0 focus:outline-none pl-2" />
								</div>
							</label>
							<label class="form-control">
								<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Payment Date</span>
								<input type="date" class="input input-bordered bg-base-100/80" />
							</label>
							<div class="flex items-end">
								<button class="btn btn-primary btn-sm w-full">Save payment</button>
							</div>
						</div>
					</div>

					<!-- Payment records table -->
					<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden">
						<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40 flex items-center justify-between">
							<div>
								<h3 class="font-display text-lg">Payment Records</h3>
								<p class="text-xs text-base-content/60 mt-0.5">Recent settlements and outstanding invoices</p>
							</div>
							<span class="text-xs text-base-content/50">{paymentRecords.length} records</span>
						</div>
						<div class="overflow-x-auto">
							<table class="table">
								<thead>
									<tr class="text-xs uppercase tracking-widest text-base-content/50 border-b border-base-300/60">
										<th class="font-medium">Invoice</th>
										<th class="font-medium">Customer</th>
										<th class="font-medium">Method</th>
										<th class="font-medium">Amount</th>
										<th class="font-medium">Payment Date</th>
										<th class="font-medium">Status</th>
									</tr>
								</thead>
								<tbody>
									{paymentRecords.length > 0 ? (
										paymentRecords.map((record: any) => (
											<tr class="hover:bg-base-200/40 transition-colors border-b border-base-300/40">
												<td class="font-medium">{record.invoiceNumber || '-'}</td>
												<td class="text-base-content/70">{record.customerName || '-'}</td>
												<td>{record.paymentMethod}</td>
												<td>${record.amount?.toFixed(2) || '0.00'}</td>
												<td>{record.paymentDate ? new Date(record.paymentDate).toLocaleDateString() : '-'}</td>
												<td>
													<span class={`badge badge-sm ${record.status === 'COMPLETED' ? 'badge-success' : record.status === 'REFUNDED' ? 'badge-error' : 'badge-warning'}`}>
														{record.status}
													</span>
												</td>
											</tr>
										))
									) : (
										<tr>
											<td colspan="6" class="text-center py-8 text-base-content/50">
												{error || 'No payment records yet'}
											</td>
										</tr>
									)}
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		)
	}
</AdminLayout>
