---
export const prerender = false;
import AdminLayout from '../../../layouts/AdminLayout.astro';
import AccessGate from '../../../components/AccessGate.astro';
import AdminPageHeader from '../../../components/admin/AdminPageHeader.astro';
import AdminStatusFlow from '../../../components/admin/AdminStatusFlow.astro';

const session = Astro.locals?.session ?? {};
const isLoggedIn = Boolean(session.isLoggedIn);
const isAdmin = Boolean(session.isAdmin);

const { id } = Astro.params;

// Fetch subscription from API
let subscription: any = null;
let customers: any[] = [];
let recurringPlans: any[] = [];
let error: string | null = null;

if (isLoggedIn && isAdmin && id) {
	try {
		// Fetch subscription details
		const subResponse = await fetch(`http://localhost:3000/subscriptions/${id}`);
		if (subResponse.ok) {
			const subData = await subResponse.json();
			subscription = {
				id: subData.subscriptionNumber || `S-${String(subData.id).padStart(4, '0')}`,
				dbId: subData.id,
				customer: subData.customerName || 'Unknown Customer',
				customerId: subData.customerId,
				status: subData.status || 'Draft',
				statusIndex: getStatusIndex(subData.status),
				plan: subData.planName || 'No Plan',
				planId: subData.planId,
				billingPeriod: subData.billingPeriod,
				paymentTerm: subData.paymentTerms || 'Net 30',
				orderDate: subData.startDate || subData.createdAt?.split('T')[0] || '',
				expiration: subData.endDate || '',
				nextInvoice: null,
				notes: subData.notes || '',
				subtotal: subData.subtotal || 0,
				discountAmount: subData.discountAmount || 0,
				tax: subData.tax || 0,
				total: subData.total || 0,
				orderLines: (subData.items || []).map((item: any) => ({
					productId: item.productId,
					product: item.productName || item.description || 'Unknown Product',
					quantity: item.quantity || 1,
					unitPrice: item.unitPrice || 0,
					discount: 0,
					taxes: item.tax || 0,
					amount: item.amount || (item.unitPrice * item.quantity)
				}))
			};
		} else if (subResponse.status === 404) {
			subscription = null;
		} else {
			error = 'Failed to load subscription';
		}

		// Fetch customers for dropdown
		const customersResponse = await fetch('http://localhost:3000/subscriptions/customers');
		if (customersResponse.ok) {
			customers = await customersResponse.json();
		}

		// Fetch recurring plans for dropdown
		const plansResponse = await fetch('http://localhost:3000/recurring-plans');
		if (plansResponse.ok) {
			recurringPlans = await plansResponse.json();
		}
	} catch (e) {
		error = 'Unable to connect to the server';
		console.error('Subscription fetch error:', e);
	}
}

function getStatusIndex(status: string): number {
	const statuses = ['Draft', 'Quotation', 'Quotation Sent', 'Confirmed', 'Active', 'Closed', 'Cancelled', 'Expired'];
	return Math.max(0, statuses.indexOf(status));
}

// Status flow changes based on current status
const getStatusFlow = (status: string) => {
	const baseFlow = ['Quotation', 'Quotation Sent', 'Confirmed'];
	if (['Confirmed', 'Active', 'Renewed', 'Upsold', 'Closed', 'Cancelled'].includes(status)) {
		return [...baseFlow, 'Closed'];
	}
	return baseFlow;
};

const statusFlow = subscription ? getStatusFlow(subscription.status) : ['Quotation', 'Quotation Sent', 'Confirmed'];
const currentStatusIndex = subscription?.statusIndex ?? 0;

// Calculate totals from order lines
const subtotal = subscription?.orderLines?.reduce((sum: number, line: any) => sum + (line.unitPrice * line.quantity), 0) ?? 0;
const totalDiscount = subscription?.orderLines?.reduce((sum: number, line: any) => sum + line.discount, 0) ?? 0;
const totalTaxes = subscription?.orderLines?.reduce((sum: number, line: any) => sum + line.taxes, 0) ?? 0;
const grandTotal = subscription?.orderLines?.reduce((sum: number, line: any) => sum + line.amount, 0) ?? 0;

// Mock quotation templates for now
const quotationTemplates = ['Starter Subscription Quote', 'Enterprise Annual', 'SMB Monthly', 'Custom Quote'];
const paymentTerms = ['Immediate', 'Net 15', 'Net 30', 'Net 60'];

// Check if subscription is in a confirmed state (can create invoice, renew, upsell, close)
const isConfirmed = subscription?.status === 'Confirmed' || subscription?.status === 'Active';
const canSend = subscription?.status === 'Quotation' || subscription?.status === 'Draft';
const canConfirm = ['Draft', 'Quotation', 'Quotation Sent'].includes(subscription?.status ?? '');
const canPreview = subscription?.status === 'Quotation Sent' || isConfirmed;
const isClosed = ['Closed', 'Cancelled', 'Expired'].includes(subscription?.status ?? '');
---

<AdminLayout title={subscription ? `TinkerTrack • ${subscription.id}` : 'TinkerTrack • Subscription Not Found'} isLoggedIn={isLoggedIn} activeTab="Subscriptions">
	{
		!isLoggedIn ? (
			<AccessGate
				badge="Login required"
				title="Sign in to view subscription"
				description="Admin workspaces are available after you sign in."
			/>
		) : !isAdmin ? (
			<AccessGate
				badge="Admin only"
				title="Admin access required"
				description="Only workspace admins can manage subscription records."
				linkHref="/profile"
				linkText="Go to profile"
				hint="Request admin access from your workspace owner."
			/>
		) : !subscription ? (
			<div class="p-6 lg:p-8">
				<div class="flex flex-col items-center justify-center py-16 text-center">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-base-content/20 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
						<path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
					</svg>
					<h1 class="font-display text-2xl font-semibold mb-2">Subscription not found</h1>
					<p class="text-base-content/60 mb-6">The subscription you're looking for doesn't exist or has been removed.</p>
					<a href="/admin/subscriptions" class="btn btn-primary btn-sm">Back to subscriptions</a>
				</div>
			</div>
		) : (
			<div class="p-6 lg:p-8" x-data={`{
				activeTab: 'orderLines',
				saving: false,
				statusLoading: false,
				
				async saveSubscription() {
					this.saving = true;
					try {
						const form = document.getElementById('subscriptionForm');
						const formData = new FormData(form);
						
						const response = await fetch('http://localhost:3000/subscriptions/${subscription.dbId}', {
							method: 'PUT',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({
								customerId: parseInt(formData.get('customerId')),
								planId: formData.get('planId') ? parseInt(formData.get('planId')) : null,
								startDate: formData.get('startDate'),
								paymentTerms: formData.get('paymentTerms'),
								notes: formData.get('notes')
							})
						});
						
						if (response.ok) {
							window.location.reload();
						} else {
							const data = await response.json();
							alert(data.error || 'Failed to save');
						}
					} catch (e) {
						alert('Error saving subscription');
					} finally {
						this.saving = false;
					}
				},
				
				async updateStatus(newStatus) {
					this.statusLoading = true;
					try {
						const response = await fetch('http://localhost:3000/subscriptions/${subscription.dbId}/status', {
							method: 'PUT',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({ status: newStatus })
						});
						
						if (response.ok) {
							window.location.reload();
						} else {
							const data = await response.json();
							alert(data.error || 'Failed to update status');
						}
					} catch (e) {
						alert('Error updating status');
					} finally {
						this.statusLoading = false;
					}
				}
			}`}>
				<AdminPageHeader eyebrow="Subscription details" title={subscription.id}>
					<Fragment slot="lead">
						<a href="/admin/subscriptions" class="btn btn-ghost btn-xs">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
							</svg>
							Back to subscriptions
						</a>
					</Fragment>
					<Fragment slot="actions">
						<!-- Primary actions row -->
						<a href="/admin/subscriptions/new" class="btn btn-outline btn-sm">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
							</svg>
							New
						</a>
						{canSend && (
							<button class="btn btn-secondary btn-sm" @click="updateStatus('Quotation Sent')" :disabled="statusLoading">
								<span x-show="!statusLoading">Send</span>
								<span x-show="statusLoading" class="loading loading-spinner loading-xs"></span>
							</button>
						)}
						{canConfirm && (
							<button class="btn btn-primary btn-sm" @click="updateStatus('Confirmed')" :disabled="statusLoading">
								<span x-show="!statusLoading">Confirm</span>
								<span x-show="statusLoading" class="loading loading-spinner loading-xs"></span>
							</button>
						)}
						{canPreview && (
							<button class="btn btn-ghost btn-sm">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
									<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
									<path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
								</svg>
								Preview
							</button>
						)}
					</Fragment>
				</AdminPageHeader>

				<!-- Confirmed subscription actions -->
				{isConfirmed && !isClosed && (
					<div class="flex flex-wrap items-center gap-2 -mt-2 mb-2">
						<a href={`/admin/subscriptions/${subscription.dbId}/invoice/new`} class="btn btn-sm btn-outline">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
							</svg>
							Create Invoice
						</a>
						<button class="btn btn-sm btn-ghost text-error" @click="updateStatus('Cancelled')" :disabled="statusLoading">Cancel</button>
						<button class="btn btn-sm btn-ghost" @click="updateStatus('Active')" :disabled="statusLoading">Activate</button>
						<button class="btn btn-sm btn-ghost" @click="updateStatus('Closed')" :disabled="statusLoading">Close</button>
					</div>
				)}

				<div class="max-w-5xl grid gap-6">
					<!-- Status flow -->
					<div class="flex items-center justify-end">
						<AdminStatusFlow statuses={statusFlow} currentIndex={currentStatusIndex} />
					</div>

					<!-- Subscription form -->
					<form id="subscriptionForm" @submit.prevent="saveSubscription()">
					<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden">
						<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40">
							<h3 class="font-display text-lg">Subscription Information</h3>
							<p class="text-xs text-base-content/60 mt-0.5">Basic subscription details</p>
						</div>
						<div class="p-5 grid gap-5">
							<!-- Row 1: Subscription Number + Expiration -->
							<div class="grid gap-5 sm:grid-cols-2">
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Subscription Number</span>
									<input type="text" value={subscription.id} class="input input-bordered bg-base-200/60" readonly />
								</label>

								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Expiration</span>
									<input type="date" value={subscription.expiration} class="input input-bordered bg-base-100/80" name="endDate" />
									<span class="label-text-alt">Expiry of quotation, after which customer cannot sign or pay</span>
								</label>
							</div>

							<!-- Row 2: Customer + Order Date -->
							<div class="grid gap-5 sm:grid-cols-2">
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Customer</span>
									<select class="select select-bordered bg-base-100/80" id="customerId" name="customerId">
										<option value="" disabled>Select customer...</option>
										{customers.map((c: any) => (
											<option value={c.id} selected={c.id === subscription.customerId}>{c.name}</option>
										))}
										<option disabled>──────────</option>
										<option value="new">+ Create new customer</option>
									</select>
								</label>

								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Order Date</span>
									<input type="date" value={subscription.orderDate} class="input input-bordered bg-base-100/80" id="startDate" name="startDate" />
								</label>
							</div>

							<!-- Row 3: Quotation Template + Recurring Plan -->
							<div class="grid gap-5 sm:grid-cols-2">
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Quotation Template</span>
									<select class="select select-bordered bg-base-100/80">
										<option value="">Select template...</option>
										{quotationTemplates.map((t) => (
											<option>{t}</option>
										))}
									</select>
								</label>

								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Recurring Plan</span>
									<select class="select select-bordered bg-base-100/80" id="planId" name="planId">
										<option value="">No Plan</option>
										{recurringPlans.map((p: any) => (
											<option value={p.id} selected={p.id === subscription.planId}>{p.planName} ({p.billingPeriod})</option>
										))}
									</select>
								</label>
							</div>

							<!-- Row 4: Empty + Payment Term -->
							<div class="grid gap-5 sm:grid-cols-2">
								<div></div>

								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Payment Term</span>
									<select class="select select-bordered bg-base-100/80" id="paymentTerms" name="paymentTerms">
										{paymentTerms.map((t) => (
											<option selected={t === subscription.paymentTerm}>{t}</option>
										))}
									</select>
								</label>
							</div>

							<!-- Row 5: Empty + Next Invoice -->
							<div class="grid gap-5 sm:grid-cols-2">
								<div></div>

								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Next Invoice</span>
									<input type="date" value={subscription.nextInvoice} class="input input-bordered bg-base-100/80" disabled={!isConfirmed} />
									<span class="label-text-alt">Date when the next invoice will be generated</span>
								</label>
							</div>
						</div>
					</div>

					<!-- Tabs: Order Lines / Other Info -->
					<div class="flex items-center gap-2 px-1">
						<button 
							class="btn btn-sm transition-all"
							:class="activeTab === 'orderLines' ? 'btn-primary' : 'btn-ghost'"
							@click="activeTab = 'orderLines'"
						>
							Order Lines
						</button>
						<button 
							class="btn btn-sm transition-all"
							:class="activeTab === 'otherInfo' ? 'btn-primary' : 'btn-ghost'"
							@click="activeTab = 'otherInfo'"
						>
							Other Info
						</button>
					</div>

					<!-- Order Lines Tab -->
					<div x-show="activeTab === 'orderLines'" x-transition>
						<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden">
							<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40 flex items-center justify-between">
								<h3 class="font-display text-lg">Order Lines</h3>
								<button class="btn btn-ghost btn-sm text-primary">
									<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
										<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
									</svg>
									Add line
								</button>
							</div>
							<div class="overflow-x-auto">
								<table class="table">
									<thead>
										<tr class="text-xs uppercase tracking-widest text-base-content/50 border-b border-base-300/60">
											<th class="font-medium">Product</th>
											<th class="font-medium text-center">Quantity</th>
											<th class="font-medium text-right">Unit Price</th>
											<th class="font-medium text-right">Discount</th>
											<th class="font-medium text-right">Taxes</th>
											<th class="font-medium text-right">Amount</th>
											<th class="w-16"></th>
										</tr>
									</thead>
									<tbody>
										{subscription.orderLines.map((line: any, index: number) => (
											<tr class="border-b border-base-300/40 hover:bg-base-200/30">
												<td class="font-medium">{line.product}</td>
												<td class="text-center">{line.quantity}</td>
												<td class="text-right font-mono text-sm">${line.unitPrice.toLocaleString()}</td>
												<td class="text-right font-mono text-sm text-error">{line.discount > 0 ? `-$${line.discount.toLocaleString()}` : '—'}</td>
												<td class="text-right font-mono text-sm text-base-content/70">${line.taxes.toLocaleString()}</td>
												<td class="text-right font-mono text-sm font-medium">${line.amount.toLocaleString()}</td>
												<td>
													<button class="btn btn-ghost btn-xs text-error">
														<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
															<path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
														</svg>
													</button>
												</td>
											</tr>
										))}
										<!-- Add new line row -->
										<tr class="bg-base-200/30">
											<td>
												<select class="select select-bordered select-sm bg-base-100/80 w-full">
													<option value="" disabled selected>Select product...</option>
													<option>Pulse Analytics Suite</option>
													<option>Retention Lab</option>
													<option>Design Toolkit</option>
													<option>Enterprise Platform</option>
												</select>
											</td>
											<td class="text-center">
												<input type="number" min="1" value="1" class="input input-bordered input-sm bg-base-100/80 w-20 text-center" />
											</td>
											<td class="text-right">
												<input type="number" step="0.01" placeholder="0.00" class="input input-bordered input-sm bg-base-100/80 w-24 text-right" />
											</td>
											<td class="text-right">
												<input type="number" step="0.01" placeholder="0.00" class="input input-bordered input-sm bg-base-100/80 w-24 text-right" />
											</td>
											<td class="text-right text-base-content/50">Auto</td>
											<td class="text-right text-base-content/50">—</td>
											<td>
												<button class="btn btn-ghost btn-xs text-primary">Add</button>
											</td>
										</tr>
									</tbody>
									<tfoot class="bg-base-100/40">
										<tr class="border-t border-base-300/60">
											<td colspan="5" class="text-right font-medium text-base-content/70">Subtotal</td>
											<td class="text-right font-mono">${subtotal.toLocaleString()}</td>
											<td></td>
										</tr>
										<tr>
											<td colspan="5" class="text-right font-medium text-error/70">Discount</td>
											<td class="text-right font-mono text-error">-${totalDiscount.toLocaleString()}</td>
											<td></td>
										</tr>
										<tr>
											<td colspan="5" class="text-right font-medium text-base-content/70">Taxes</td>
											<td class="text-right font-mono">${totalTaxes.toLocaleString()}</td>
											<td></td>
										</tr>
										<tr class="border-t border-base-300/60">
											<td colspan="5" class="text-right font-display text-lg">Total</td>
											<td class="text-right font-mono text-lg font-bold">${grandTotal.toLocaleString()}</td>
											<td></td>
										</tr>
									</tfoot>
								</table>
							</div>
						</div>
					</div>

					<!-- Other Info Tab -->
					<div x-show="activeTab === 'otherInfo'" x-transition>
						<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden">
							<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40">
								<h3 class="font-display text-lg">Additional Information</h3>
							</div>
							<div class="p-5 grid gap-5">
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Internal Notes</span>
									<textarea class="textarea textarea-bordered bg-base-100/80 h-32" name="notes" placeholder="Add internal notes about this subscription...">{subscription.notes}</textarea>
								</label>

								<div class="grid gap-5 sm:grid-cols-2">
									<label class="form-control">
										<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Created Date</span>
										<input type="text" value="February 1, 2026" class="input input-bordered bg-base-200/60" readonly />
									</label>

									<label class="form-control">
										<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Last Modified</span>
										<input type="text" value="February 8, 2026" class="input input-bordered bg-base-200/60" readonly />
									</label>
								</div>
							</div>
						</div>
					</div>

					<!-- Action buttons -->
					<div class="flex items-center justify-end gap-3 pt-2">
						<a href="/admin/subscriptions" class="btn btn-ghost btn-sm">Cancel</a>
						<button type="submit" class="btn btn-primary btn-sm" :disabled="saving">
							<span x-show="!saving" class="flex items-center gap-2">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
									<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
								</svg>
								Save changes
							</span>
							<span x-show="saving" class="loading loading-spinner loading-xs"></span>
						</button>
					</div>
					</form>
				</div>
			</div>
		)
	}
</AdminLayout>
