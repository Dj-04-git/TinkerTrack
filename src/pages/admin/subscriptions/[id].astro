---
export const prerender = false;
import AdminLayout from '../../../layouts/AdminLayout.astro';
import AccessGate from '../../../components/AccessGate.astro';
import AdminPageHeader from '../../../components/admin/AdminPageHeader.astro';
import AdminStatusFlow from '../../../components/admin/AdminStatusFlow.astro';

const session = Astro.locals?.session ?? {};
const isLoggedIn = Boolean(session.isLoggedIn);
const isAdmin = Boolean(session.isAdmin);

const { id } = Astro.params;

// Mock subscription data
const subscriptions: Record<string, any> = {
	'SO001': {
		id: 'SO001',
		customer: 'Harbor SaaS Studio',
		status: 'Quotation',
		statusIndex: 0,
		plan: 'Monthly Plan',
		paymentTerm: 'Net 15',
		orderDate: '2026-02-01',
		expiration: '2026-02-15',
		nextInvoice: '2026-03-01',
		quotationTemplate: 'Starter Subscription Quote',
		orderLines: [
			{ product: 'Pulse Analytics Suite', quantity: 1, unitPrice: 2400, discount: 0, taxes: 360, amount: 2760 },
			{ product: 'Retention Lab', quantity: 2, unitPrice: 980, discount: 98, taxes: 186.2, amount: 2048.2 }
		],
		notes: 'Customer requested extended trial period.'
	},
	'SO002': {
		id: 'SO002',
		customer: 'Sunward Labs',
		status: 'Confirmed',
		statusIndex: 2,
		plan: 'Annual Plan',
		paymentTerm: 'Net 30',
		orderDate: '2026-01-15',
		expiration: '2027-01-15',
		nextInvoice: '2026-02-15',
		quotationTemplate: 'Enterprise Annual',
		orderLines: [
			{ product: 'Enterprise Platform', quantity: 1, unitPrice: 24000, discount: 2400, taxes: 3240, amount: 24840 },
			{ product: 'Priority Support', quantity: 1, unitPrice: 4800, discount: 0, taxes: 720, amount: 5520 }
		],
		notes: ''
	},
	'SO003': {
		id: 'SO003',
		customer: 'Flux Interactive',
		status: 'Quotation Sent',
		statusIndex: 1,
		plan: 'Monthly Plan',
		paymentTerm: 'Net 15',
		orderDate: '2026-02-05',
		expiration: '2026-02-20',
		nextInvoice: '2026-03-05',
		quotationTemplate: 'Starter Subscription Quote',
		orderLines: [
			{ product: 'Design Toolkit', quantity: 3, unitPrice: 800, discount: 120, taxes: 340.8, amount: 2620.8 }
		],
		notes: 'Awaiting customer response.'
	},
	'SO004': {
		id: 'SO004',
		customer: 'Apex Dynamics',
		status: 'Closed',
		statusIndex: 5,
		plan: 'Quarterly Plan',
		paymentTerm: 'Net 30',
		orderDate: '2025-10-01',
		expiration: '2026-01-01',
		nextInvoice: null,
		quotationTemplate: 'SMB Monthly',
		orderLines: [
			{ product: 'Design Toolkit', quantity: 2, unitPrice: 800, discount: 0, taxes: 240, amount: 1840 }
		],
		notes: 'Subscription closed by customer request.'
	}
};

const subscription = subscriptions[id ?? ''] ?? null;

// Status flow changes based on current status
// Base flow: Quotation → Quotation Sent → Confirmed
// After Confirmed, additional states: Close, Renew, Upsell (in that order)
const getStatusFlow = (status: string) => {
	const baseFlow = ['Quotation', 'Quotation Sent', 'Confirmed'];
	if (['Confirmed', 'Renewed', 'Upsold', 'Closed', 'Cancelled'].includes(status)) {
		return [...baseFlow, 'Closed'];
	}
	return baseFlow;
};

const statusFlow = subscription ? getStatusFlow(subscription.status) : ['Quotation', 'Quotation Sent', 'Confirmed'];
const currentStatusIndex = subscription?.statusIndex ?? 0;

// Calculate totals
const subtotal = subscription?.orderLines?.reduce((sum: number, line: any) => sum + (line.unitPrice * line.quantity), 0) ?? 0;
const totalDiscount = subscription?.orderLines?.reduce((sum: number, line: any) => sum + line.discount, 0) ?? 0;
const totalTaxes = subscription?.orderLines?.reduce((sum: number, line: any) => sum + line.taxes, 0) ?? 0;
const grandTotal = subscription?.orderLines?.reduce((sum: number, line: any) => sum + line.amount, 0) ?? 0;

// Mock customers and templates for dropdowns
const customers = ['Harbor SaaS Studio', 'Sunward Labs', 'Flux Interactive', 'Apex Dynamics', 'Coastal Commerce'];
const quotationTemplates = ['Starter Subscription Quote', 'Enterprise Annual', 'SMB Monthly', 'Custom Quote'];
const recurringPlans = ['Weekly Plan', 'Monthly Plan', 'Quarterly Plan', 'Annual Plan'];
const paymentTerms = ['Immediate', 'Net 15', 'Net 30', 'Net 60'];

// Check if subscription is in a confirmed state (can create invoice, renew, upsell, close)
const isConfirmed = subscription?.status === 'Confirmed';
const canSend = subscription?.status === 'Quotation';
const canConfirm = ['Quotation', 'Quotation Sent'].includes(subscription?.status ?? '');
const canPreview = subscription?.status === 'Quotation Sent' || isConfirmed;
const isClosed = ['Closed', 'Cancelled'].includes(subscription?.status ?? '');
---

<AdminLayout title={subscription ? `TinkerTrack • ${subscription.id}` : 'TinkerTrack • Subscription Not Found'} isLoggedIn={isLoggedIn} activeTab="Subscriptions">
	{
		!isLoggedIn ? (
			<AccessGate
				badge="Login required"
				title="Sign in to view subscription"
				description="Admin workspaces are available after you sign in."
			/>
		) : !isAdmin ? (
			<AccessGate
				badge="Admin only"
				title="Admin access required"
				description="Only workspace admins can manage subscription records."
				linkHref="/profile"
				linkText="Go to profile"
				hint="Request admin access from your workspace owner."
			/>
		) : !subscription ? (
			<div class="p-6 lg:p-8">
				<div class="flex flex-col items-center justify-center py-16 text-center">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-base-content/20 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
						<path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
					</svg>
					<h1 class="font-display text-2xl font-semibold mb-2">Subscription not found</h1>
					<p class="text-base-content/60 mb-6">The subscription you're looking for doesn't exist or has been removed.</p>
					<a href="/admin/subscriptions" class="btn btn-primary btn-sm">Back to subscriptions</a>
				</div>
			</div>
		) : (
			<div class="p-6 lg:p-8" x-data="{ activeTab: 'orderLines' }">
				<AdminPageHeader eyebrow="Subscription details" title={subscription.id}>
					<Fragment slot="lead">
						<a href="/admin/subscriptions" class="btn btn-ghost btn-xs">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
							</svg>
							Back to subscriptions
						</a>
					</Fragment>
					<Fragment slot="actions">
						<!-- Primary actions row -->
						<a href="/admin/subscriptions/new" class="btn btn-outline btn-sm">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
							</svg>
							New
						</a>
						{canSend && (
							<button class="btn btn-secondary btn-sm">Send</button>
						)}
						{canConfirm && (
							<button class="btn btn-primary btn-sm">Confirm</button>
						)}
						{canPreview && (
							<button class="btn btn-ghost btn-sm">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
									<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
									<path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
								</svg>
								Preview
							</button>
						)}
					</Fragment>
				</AdminPageHeader>

				<!-- Confirmed subscription actions -->
				{isConfirmed && !isClosed && (
					<div class="flex flex-wrap items-center gap-2 -mt-2 mb-2">
						<a href={`/admin/subscriptions/${subscription.id}/invoice/new`} class="btn btn-sm btn-outline">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
							</svg>
							Create Invoice
						</a>
						<button class="btn btn-sm btn-ghost text-error">Cancel</button>
						<button class="btn btn-sm btn-ghost">Renew</button>
						<button class="btn btn-sm btn-ghost">Upsell</button>
						<button class="btn btn-sm btn-ghost">Close</button>
					</div>
				)}

				<div class="max-w-5xl grid gap-6">
					<!-- Status flow -->
					<div class="flex items-center justify-end">
						<AdminStatusFlow statuses={statusFlow} currentIndex={currentStatusIndex} />
					</div>

					<!-- Subscription form -->
					<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden">
						<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40">
							<h3 class="font-display text-lg">Subscription Information</h3>
							<p class="text-xs text-base-content/60 mt-0.5">Basic subscription details</p>
						</div>
						<div class="p-5 grid gap-5">
							<!-- Row 1: Subscription Number + Expiration -->
							<div class="grid gap-5 sm:grid-cols-2">
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Subscription Number</span>
									<input type="text" value={subscription.id} class="input input-bordered bg-base-200/60" readonly />
								</label>

								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Expiration</span>
									<input type="date" value={subscription.expiration} class="input input-bordered bg-base-100/80" />
									<span class="label-text-alt">Expiry of quotation, after which customer cannot sign or pay</span>
								</label>
							</div>

							<!-- Row 2: Customer + Order Date -->
							<div class="grid gap-5 sm:grid-cols-2">
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Customer</span>
									<select class="select select-bordered bg-base-100/80">
										{customers.map((c) => (
											<option selected={c === subscription.customer}>{c}</option>
										))}
										<option disabled>──────────</option>
										<option value="new">+ Create new customer</option>
									</select>
								</label>

								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Order Date</span>
									<input type="date" value={subscription.orderDate} class="input input-bordered bg-base-100/80" />
								</label>
							</div>

							<!-- Row 3: Quotation Template + Recurring Plan -->
							<div class="grid gap-5 sm:grid-cols-2">
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Quotation Template</span>
									<select class="select select-bordered bg-base-100/80">
										<option value="">Select template...</option>
										{quotationTemplates.map((t) => (
											<option selected={t === subscription.quotationTemplate}>{t}</option>
										))}
									</select>
								</label>

								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Recurring Plan</span>
									<select class="select select-bordered bg-base-100/80">
										{recurringPlans.map((p) => (
											<option selected={p === subscription.plan}>{p}</option>
										))}
									</select>
								</label>
							</div>

							<!-- Row 4: Empty + Payment Term -->
							<div class="grid gap-5 sm:grid-cols-2">
								<div></div>

								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Payment Term</span>
									<select class="select select-bordered bg-base-100/80">
										{paymentTerms.map((t) => (
											<option selected={t === subscription.paymentTerm}>{t}</option>
										))}
									</select>
								</label>
							</div>

							<!-- Row 5: Empty + Next Invoice -->
							<div class="grid gap-5 sm:grid-cols-2">
								<div></div>

								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Next Invoice</span>
									<input type="date" value={subscription.nextInvoice} class="input input-bordered bg-base-100/80" disabled={!isConfirmed} />
									<span class="label-text-alt">Date when the next invoice will be generated</span>
								</label>
							</div>
						</div>
					</div>

					<!-- Tabs: Order Lines / Other Info -->
					<div class="flex items-center gap-2 px-1">
						<button 
							class="btn btn-sm transition-all"
							:class="activeTab === 'orderLines' ? 'btn-primary' : 'btn-ghost'"
							@click="activeTab = 'orderLines'"
						>
							Order Lines
						</button>
						<button 
							class="btn btn-sm transition-all"
							:class="activeTab === 'otherInfo' ? 'btn-primary' : 'btn-ghost'"
							@click="activeTab = 'otherInfo'"
						>
							Other Info
						</button>
					</div>

					<!-- Order Lines Tab -->
					<div x-show="activeTab === 'orderLines'" x-transition>
						<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden">
							<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40 flex items-center justify-between">
								<h3 class="font-display text-lg">Order Lines</h3>
								<button class="btn btn-ghost btn-sm text-primary">
									<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
										<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
									</svg>
									Add line
								</button>
							</div>
							<div class="overflow-x-auto">
								<table class="table">
									<thead>
										<tr class="text-xs uppercase tracking-widest text-base-content/50 border-b border-base-300/60">
											<th class="font-medium">Product</th>
											<th class="font-medium text-center">Quantity</th>
											<th class="font-medium text-right">Unit Price</th>
											<th class="font-medium text-right">Discount</th>
											<th class="font-medium text-right">Taxes</th>
											<th class="font-medium text-right">Amount</th>
											<th class="w-16"></th>
										</tr>
									</thead>
									<tbody>
										{subscription.orderLines.map((line: any, index: number) => (
											<tr class="border-b border-base-300/40 hover:bg-base-200/30">
												<td class="font-medium">{line.product}</td>
												<td class="text-center">{line.quantity}</td>
												<td class="text-right font-mono text-sm">${line.unitPrice.toLocaleString()}</td>
												<td class="text-right font-mono text-sm text-error">{line.discount > 0 ? `-$${line.discount.toLocaleString()}` : '—'}</td>
												<td class="text-right font-mono text-sm text-base-content/70">${line.taxes.toLocaleString()}</td>
												<td class="text-right font-mono text-sm font-medium">${line.amount.toLocaleString()}</td>
												<td>
													<button class="btn btn-ghost btn-xs text-error">
														<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
															<path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
														</svg>
													</button>
												</td>
											</tr>
										))}
										<!-- Add new line row -->
										<tr class="bg-base-200/30">
											<td>
												<select class="select select-bordered select-sm bg-base-100/80 w-full">
													<option value="" disabled selected>Select product...</option>
													<option>Pulse Analytics Suite</option>
													<option>Retention Lab</option>
													<option>Design Toolkit</option>
													<option>Enterprise Platform</option>
												</select>
											</td>
											<td class="text-center">
												<input type="number" min="1" value="1" class="input input-bordered input-sm bg-base-100/80 w-20 text-center" />
											</td>
											<td class="text-right">
												<input type="number" step="0.01" placeholder="0.00" class="input input-bordered input-sm bg-base-100/80 w-24 text-right" />
											</td>
											<td class="text-right">
												<input type="number" step="0.01" placeholder="0.00" class="input input-bordered input-sm bg-base-100/80 w-24 text-right" />
											</td>
											<td class="text-right text-base-content/50">Auto</td>
											<td class="text-right text-base-content/50">—</td>
											<td>
												<button class="btn btn-ghost btn-xs text-primary">Add</button>
											</td>
										</tr>
									</tbody>
									<tfoot class="bg-base-100/40">
										<tr class="border-t border-base-300/60">
											<td colspan="5" class="text-right font-medium text-base-content/70">Subtotal</td>
											<td class="text-right font-mono">${subtotal.toLocaleString()}</td>
											<td></td>
										</tr>
										<tr>
											<td colspan="5" class="text-right font-medium text-error/70">Discount</td>
											<td class="text-right font-mono text-error">-${totalDiscount.toLocaleString()}</td>
											<td></td>
										</tr>
										<tr>
											<td colspan="5" class="text-right font-medium text-base-content/70">Taxes</td>
											<td class="text-right font-mono">${totalTaxes.toLocaleString()}</td>
											<td></td>
										</tr>
										<tr class="border-t border-base-300/60">
											<td colspan="5" class="text-right font-display text-lg">Total</td>
											<td class="text-right font-mono text-lg font-bold">${grandTotal.toLocaleString()}</td>
											<td></td>
										</tr>
									</tfoot>
								</table>
							</div>
						</div>
					</div>

					<!-- Other Info Tab -->
					<div x-show="activeTab === 'otherInfo'" x-transition>
						<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden">
							<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40">
								<h3 class="font-display text-lg">Additional Information</h3>
							</div>
							<div class="p-5 grid gap-5">
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Internal Notes</span>
									<textarea class="textarea textarea-bordered bg-base-100/80 h-32" placeholder="Add internal notes about this subscription...">{subscription.notes}</textarea>
								</label>

								<div class="grid gap-5 sm:grid-cols-2">
									<label class="form-control">
										<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Created Date</span>
										<input type="text" value="February 1, 2026" class="input input-bordered bg-base-200/60" readonly />
									</label>

									<label class="form-control">
										<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Last Modified</span>
										<input type="text" value="February 8, 2026" class="input input-bordered bg-base-200/60" readonly />
									</label>
								</div>
							</div>
						</div>
					</div>

					<!-- Action buttons -->
					<div class="flex items-center justify-end gap-3 pt-2">
						<a href="/admin/subscriptions" class="btn btn-ghost btn-sm">Cancel</a>
						<button class="btn btn-primary btn-sm">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
							</svg>
							Save changes
						</button>
					</div>
				</div>
			</div>
		)
	}
</AdminLayout>
