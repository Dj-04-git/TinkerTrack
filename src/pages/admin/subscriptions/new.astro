---
export const prerender = false;
import AdminLayout from '../../../layouts/AdminLayout.astro';
import AccessGate from '../../../components/AccessGate.astro';
import AdminPageHeader from '../../../components/admin/AdminPageHeader.astro';
import AdminStatusFlow from '../../../components/admin/AdminStatusFlow.astro';
import QuotationManager from '../../../components/admin/QuotationManager.astro';

const session = Astro.locals?.session ?? {};
const isLoggedIn = Boolean(session.isLoggedIn);
const isAdmin = Boolean(session.isAdmin);

// Fetch data from API
let customers: any[] = [];
let recurringPlans: any[] = [];
let subscriptionCount = 0;
let error: string | null = null;

if (isLoggedIn && isAdmin) {
	try {
		// Fetch customers for dropdown
		const customersResponse = await fetch('http://localhost:3000/subscriptions/customers');
		if (customersResponse.ok) {
			customers = await customersResponse.json();
		}

		// Fetch recurring plans for dropdown
		const plansResponse = await fetch('http://localhost:3000/recurring-plans');
		if (plansResponse.ok) {
			recurringPlans = await plansResponse.json();
		}

		// Get subscription count for next number preview
		const countResponse = await fetch('http://localhost:3000/subscriptions/count');
		if (countResponse.ok) {
			const data = await countResponse.json();
			subscriptionCount = data.count || 0;
		}
	} catch (e) {
		error = 'Unable to connect to the server';
		console.error('Subscription data fetch error:', e);
	}
}

// Generate next subscription number (preview)
const nextSubNumber = `S-${String(subscriptionCount + 1).padStart(4, '0')}`;

const paymentTerms = ['Immediate', 'Net 15', 'Net 30', 'Net 60'];

const statusFlow = ['Quotation', 'Quotation Sent', 'Confirmed'];

// Default expiration (15 days from now)
const defaultExpiration = new Date();
defaultExpiration.setDate(defaultExpiration.getDate() + 15);
const formattedExpiration = defaultExpiration.toISOString().split('T')[0];

// Default start date (today)
const today = new Date().toISOString().split('T')[0];
---

<AdminLayout title="TinkerTrack • New Subscription" isLoggedIn={isLoggedIn} activeTab="Subscriptions">
	{
		!isLoggedIn ? (
			<AccessGate
				badge="Login required"
				title="Sign in to create subscription"
				description="Admin workspaces are available after you sign in."
			/>
		) : !isAdmin ? (
			<AccessGate
				badge="Admin only"
				title="Admin access required"
				description="Only workspace admins can create subscription records."
				linkHref="/profile"
				linkText="Go to profile"
				hint="Request admin access from your workspace owner."
			/>
		) : (
			<div class="p-6 lg:p-8" x-data={`{
				saving: false,
				
				async createSubscription() {
					this.saving = true;
					try {
						const form = document.getElementById('newSubscriptionForm');
						const formData = new FormData(form);
						
						const customerId = formData.get('customerId');
						if (!customerId) {
							alert('Please select a customer');
							this.saving = false;
							return;
						}
						
						const response = await fetch('http://localhost:3000/subscriptions', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({
								customerId: parseInt(customerId),
								planId: formData.get('planId') ? parseInt(formData.get('planId')) : null,
								startDate: formData.get('startDate') || null,
								endDate: formData.get('endDate') || null,
								paymentTerms: formData.get('paymentTerms'),
								notes: formData.get('notes') || null
							})
						});
						
						if (response.ok) {
							const data = await response.json();
							window.location.href = '/admin/subscriptions/' + data.subscriptionId;
						} else {
							const data = await response.json();
							alert(data.error || 'Failed to create subscription');
						}
					} catch (e) {
						alert('Error creating subscription');
					} finally {
						this.saving = false;
					}
				}
			}`}>
				<AdminPageHeader eyebrow="New subscription" title={nextSubNumber}>
					<Fragment slot="lead">
						<a href="/admin/subscriptions" class="btn btn-ghost btn-xs">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
							</svg>
							Back to subscriptions
						</a>
					</Fragment>
					<Fragment slot="actions">
						<button class="btn btn-secondary btn-sm" disabled>Send</button>
						<button class="btn btn-primary btn-sm" disabled>Confirm</button>
					</Fragment>
				</AdminPageHeader>

				<div class="max-w-5xl grid gap-6">
					<!-- Status flow -->
					<div class="flex items-center justify-end">
						<AdminStatusFlow statuses={statusFlow} currentIndex={0} />
					</div>

					<!-- Subscription form -->
					<form id="newSubscriptionForm" @submit.prevent="createSubscription()">
					<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden">
						<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40">
							<h3 class="font-display text-lg">Subscription Information</h3>
							<p class="text-xs text-base-content/60 mt-0.5">Basic subscription details</p>
						</div>
						<div class="p-5 grid gap-5">
							<!-- Row 1: Subscription Number + Customer -->
							<div class="grid gap-5 sm:grid-cols-2">
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Subscription Number</span>
									<input type="text" value={nextSubNumber} class="input input-bordered bg-base-200/60" readonly />
									<span class="label-text-alt">Auto-generated</span>
								</label>

								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Customer</span>
									<select class="select select-bordered bg-base-100/80" name="customerId" required>
										<option value="" disabled selected>Select customer...</option>
										{customers.map((c: any) => (
											<option value={c.id}>{c.name}</option>
										))}
										<option disabled>──────────</option>
										<option value="new">+ Create new customer</option>
									</select>
								</label>
							</div>

							<!-- Row 2: Expiration + Recurring Plan -->
							<div class="grid gap-5 sm:grid-cols-2">
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Expiration</span>
									<input type="date" value={formattedExpiration} class="input input-bordered bg-base-100/80" name="endDate" />
									<span class="label-text-alt">Expiry of quotation, after which customer cannot sign or pay</span>
								</label>

								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Recurring Plan</span>
									<select class="select select-bordered bg-base-100/80" name="planId">
										<option value="">No Plan</option>
										{recurringPlans.map((p: any) => (
											<option value={p.id}>{p.planName} ({p.billingPeriod})</option>
										))}
									</select>
								</label>

								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Payment Term</span>
									<select class="select select-bordered bg-base-100/80" name="paymentTerms">
										{paymentTerms.map((t) => (
											<option>{t}</option>
										))}
									</select>
								</label>
							</div>
						</div>
					</div>

					<!-- Quotations Section -->
					<QuotationManager />

					<!-- Additional Information -->
					<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden">
						<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40">
							<h3 class="font-display text-lg">Additional Information</h3>
						</div>
						<div class="p-5 grid gap-5">
							<label class="form-control">
								<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Internal Notes</span>
								<textarea class="textarea textarea-bordered bg-base-100/80 h-32" name="notes" placeholder="Add internal notes about this subscription..."></textarea>
							</label>

							<div class="grid gap-5 sm:grid-cols-2">
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Start Date</span>
									<input type="date" class="input input-bordered bg-base-100/80" name="startDate" value={today} />
									<span class="label-text-alt">When the subscription should start</span>
								</label>

								<div class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Status</span>
									<div class="badge badge-outline mt-2">Draft</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Action buttons -->
					<div class="flex items-center justify-end gap-3 pt-2">
						<a href="/admin/subscriptions" class="btn btn-ghost btn-sm">Cancel</a>
						<button type="submit" class="btn btn-primary btn-sm" :disabled="saving">
							<span x-show="!saving" class="flex items-center gap-2">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
									<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
								</svg>
								Create subscription
							</span>
							<span x-show="saving" class="loading loading-spinner loading-xs"></span>
						</button>
					</div>
					</form>
				</div>
			</div>
		)
	}
</AdminLayout>