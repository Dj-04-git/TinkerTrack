---
export const prerender = false;
import AdminLayout from '../../../layouts/AdminLayout.astro';
import AccessGate from '../../../components/AccessGate.astro';
import AdminPageHeader from '../../../components/admin/AdminPageHeader.astro';

const session = Astro.locals?.session ?? {};
const isLoggedIn = Boolean(session.isLoggedIn);
const isAdmin = Boolean(session.isAdmin);

// Fetch data from API
let recurringPlans: any[] = [];
let products: any[] = [];
let quotationTemplates: any[] = [];
let error: string | null = null;

if (isLoggedIn && isAdmin) {
	try {
		// Fetch recurring plans for dropdown
		const plansResponse = await fetch('http://localhost:3000/recurring-plans');
		if (plansResponse.ok) {
			recurringPlans = await plansResponse.json();
		}

		// Fetch products for dropdown
		const productsResponse = await fetch('http://localhost:3000/products');
		if (productsResponse.ok) {
			products = await productsResponse.json();
		}

		// Fetch quotation templates
		const templatesResponse = await fetch('http://localhost:3000/quotation-templates');
		if (templatesResponse.ok) {
			quotationTemplates = await templatesResponse.json();
		}
	} catch (e) {
		error = 'Unable to connect to the server';
		console.error('Quotation template fetch error:', e);
	}
}

const template = {
	name: '',
	validityDays: 14,
	recurringPlan: '',
	lastForever: false,
	endAfterValue: 12,
	endAfterUnit: 'Month'
};

const productLines: any[] = [];
---

<AdminLayout title="TinkerTrack â€¢ Quotation Templates" isLoggedIn={isLoggedIn} activeSubTab="Quotation Template">
	{
		!isLoggedIn ? (
			<AccessGate
				badge="Login required"
				title="Sign in to manage quotation templates"
				description="Admin configuration pages are available after you sign in."
			/>
		) : !isAdmin ? (
			<AccessGate
				badge="Admin only"
				title="Admin access required"
				description="Only admins can manage configuration settings."
				linkHref="/profile"
				linkText="Go to profile"
				hint="Request admin access from your workspace owner."
			/>
		) : (
			<div class="p-6 lg:p-8">
				<AdminPageHeader eyebrow="Configuration" title="Quotation Template">
					<Fragment slot="actions">
						<button class="btn btn-outline btn-sm">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
							</svg>
							New Template
						</button>
						<span class="badge badge-info badge-sm">Subscription</span>
					</Fragment>
				</AdminPageHeader>

				<div class="max-w-4xl grid gap-6" x-data={`{ lastForever: ${template.lastForever} }`}>
					<!-- Template Details -->
					<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden">
						<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40">
							<h3 class="font-display text-lg">Quotation Template</h3>
							<p class="text-xs text-base-content/60 mt-0.5">Predefined templates used during subscription creation</p>
						</div>
						<div class="p-5 grid gap-5">
							<label class="form-control w-full">
								<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Template Name</span>
								<input
									type="text"
									value={template.name}
									placeholder="e.g. Starter Subscription Quote"
									class="input input-bordered bg-base-100/80"
								/>
							</label>

							<div class="grid gap-5 sm:grid-cols-2">
								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Quotation Validity</span>
									<div class="flex items-center gap-2">
										<input
											type="number"
											min="1"
											value={template.validityDays}
											class="input input-bordered bg-base-100/80 w-24"
										/>
									</div>
									<span class="label-text-alt">
										Validity is measured in days. If not confirmed within this time, the subscription auto-closes.
									</span>
								</label>

								<label class="form-control">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Recurring Plan</span>
									<select class="select select-bordered bg-base-100/80">
										<option value="" disabled selected>Select plan...</option>
										{recurringPlans.map((plan: any) => (
											<option value={plan.id}>{plan.name}</option>
										))}
									</select>
								</label>
							</div>

							<div class="grid gap-5 sm:grid-cols-2">
								<label class="flex items-center gap-3 cursor-pointer">
									<input type="checkbox" class="checkbox checkbox-primary checkbox-sm" x-model="lastForever" />
									<div>
										<span class="text-sm font-medium">Last Forever</span>
										<p class="text-xs text-base-content/50">Keep this template active without an end date</p>
									</div>
								</label>

								<label class="form-control" :class="lastForever ? 'opacity-50' : ''">
									<span class="label-text text-xs uppercase tracking-widest text-base-content/60">End After</span>
									<div class="flex items-center gap-2">
										<input
											type="number"
											min="1"
											value={template.endAfterValue}
											:disabled="lastForever"
											class="input input-bordered bg-base-100/80 w-24"
										/>
										<select class="select select-bordered bg-base-100/80" :disabled="lastForever">
											{['Week', 'Month', 'Year'].map((unit) => (
												<option selected={unit === template.endAfterUnit}>{unit}</option>
											))}
										</select>
									</div>
									<span class="label-text-alt">
										Set how long the subscription should stay active
									</span>
								</label>
							</div>
						</div>
					</div>

					<!-- Product lines table -->
					<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden">
						<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40 flex items-center justify-between">
							<div>
								<h3 class="font-display text-lg">Product Lines</h3>
								<p class="text-xs text-base-content/60 mt-0.5">Items included in this quotation template</p>
							</div>
							<button class="btn btn-ghost btn-sm text-primary">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
									<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
								</svg>
								Add line
							</button>
						</div>
						<div class="overflow-x-auto">
							<table class="table">
								<thead>
									<tr class="text-xs uppercase tracking-widest text-base-content/50 border-b border-base-300/60">
										<th class="font-medium">Product</th>
										<th class="font-medium">Description</th>
										<th class="font-medium">Quantity</th>
										<th class="w-20"></th>
									</tr>
								</thead>
								<tbody>
									{productLines.length > 0 ? (
										productLines.map((line) => (
											<tr class="hover:bg-base-200/40 transition-colors border-b border-base-300/40">
												<td class="font-medium">{line.product}</td>
												<td class="text-base-content/70">{line.description}</td>
												<td>{line.quantity} qty</td>
												<td>
													<button class="btn btn-ghost btn-xs text-error">Remove</button>
												</td>
											</tr>
										))
									) : (
										<tr>
											<td colspan="4" class="text-center py-8 text-base-content/50">
												No product lines yet
											</td>
										</tr>
									)}
									<tr class="bg-base-200/30">
										<td>
											<select class="select select-bordered bg-base-100/80 w-full">
												<option value="" disabled selected>Select product...</option>
												{products.map((product: any) => (
													<option value={product.id}>{product.productName}</option>
												))}
											</select>
										</td>
										<td>
											<input
												type="text"
												placeholder="Description"
												class="input input-bordered bg-base-100/80 w-full"
											/>
										</td>
										<td>
											<input
												type="number"
												min="1"
												placeholder="Quantity"
												class="input input-bordered bg-base-100/80 w-28"
											/>
										</td>
										<td>
											<button class="btn btn-ghost btn-xs text-primary">Add</button>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
						<div class="px-5 py-3 border-t border-base-300/60 bg-base-100/40 flex items-center justify-between">
							<span class="text-xs text-base-content/50">{productLines.length} lines</span>
							<button class="btn btn-primary btn-sm">Save template</button>
						</div>
					</div>
				</div>
			</div>
		)
	}
</AdminLayout>
