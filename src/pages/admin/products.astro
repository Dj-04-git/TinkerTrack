---
export const prerender = false;
import AdminLayout from '../../layouts/AdminLayout.astro';
import AccessGate from '../../components/AccessGate.astro';
import ProductListTable from '../../components/admin/ProductListTable.astro';
import AdminPageHeader from '../../components/admin/AdminPageHeader.astro';

const session = Astro.locals?.session ?? {};
const isLoggedIn = Boolean(session.isLoggedIn);
const isAdmin = Boolean(session.isAdmin);

// Fetch products from API
let products: any[] = [];
let error: string | null = null;

if (isLoggedIn && isAdmin) {
	try {
		const response = await fetch('http://localhost:3000/products');
		if (response.ok) {
			const data = await response.json();
			products = data.map((p: any) => ({
				id: p.id,
				name: p.productName,
				type: p.productType || 'Service',
				salesPrice: p.salesPrice || 0,
				costPrice: p.costPrice || 0
			}));
		} else {
			error = 'Failed to load products';
		}
	} catch (e) {
		error = 'Unable to connect to the server';
		console.error('Product fetch error:', e);
	}
}
---

<AdminLayout title="TinkerTrack â€¢ Products" isLoggedIn={isLoggedIn} activeTab="Products">
	{
		!isLoggedIn ? (
			<AccessGate
				badge="Login required"
				title="Sign in to manage products"
				description="Admin product pages are available after you sign in."
			/>
		) : !isAdmin ? (
			<AccessGate
				badge="Admin only"
				title="Admin access required"
				description="Only admins can manage product catalogs."
				linkHref="/profile"
				linkText="Go to profile"
				hint="Request admin access from your workspace owner if you need to edit products."
			/>
		) : (
			<div class="p-6 lg:p-8">
				<AdminPageHeader eyebrow="Product management" title="Products">
					<Fragment slot="actions">
						<a href="/admin/products/new" class="btn btn-primary btn-sm">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
							</svg>
							New product
						</a>
					</Fragment>
				</AdminPageHeader>

				{error && (
					<div class="alert alert-warning mb-6 max-w-4xl">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
						</svg>
						<span>{error}</span>
					</div>
				)}

				<!-- Product list -->
				<div class="max-w-4xl">
					<ProductListTable products={products} />
				</div>
			</div>
		)
	}
</AdminLayout>

<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
