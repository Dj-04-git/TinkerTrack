---
export const prerender = false;
import AdminLayout from '../../layouts/AdminLayout.astro';
import AccessGate from '../../components/AccessGate.astro';
import AdminPageHeader from '../../components/admin/AdminPageHeader.astro';

const session = Astro.locals?.session ?? {};
const isLoggedIn = Boolean(session.isLoggedIn);
const isAdmin = Boolean(session.isAdmin);

// Fetch subscriptions from API
let subscriptions: any[] = [];
let error: string | null = null;

if (isLoggedIn && isAdmin) {
	try {
		const response = await fetch('http://localhost:3000/subscriptions');
		if (response.ok) {
			const data = await response.json();
			// Transform API response to match table structure
			subscriptions = data.map((sub: any) => ({
				id: sub.subscriptionNumber || `S-${String(sub.id).padStart(4, '0')}`,
				dbId: sub.id,
				customer: sub.customerName || 'Unknown Customer',
				status: sub.status || 'Draft',
				plan: sub.planName || sub.billingPeriod || 'No Plan',
				orderDate: sub.startDate || sub.createdAt?.split('T')[0] || '',
				expiration: sub.endDate || '',
				amount: sub.total || 0
			}));
		} else {
			error = 'Failed to load subscriptions';
		}
	} catch (e) {
		error = 'Unable to connect to the server';
		console.error('Subscription fetch error:', e);
	}
}

const getStatusBadgeClass = (status: string) => {
	switch (status) {
		case 'Quotation': return 'badge-warning badge-outline';
		case 'Quotation Sent': return 'badge-info badge-outline';
		case 'Confirmed': return 'badge-success';
		case 'Active': return 'badge-success';
		case 'Closed': return 'badge-neutral';
		case 'Cancelled': return 'badge-error badge-outline';
		case 'Draft': return 'badge-ghost';
		case 'Expired': return 'badge-error';
		default: return 'badge-ghost';
	}
};
---

<AdminLayout title="TinkerTrack â€¢ Subscriptions" isLoggedIn={isLoggedIn} activeTab="Subscriptions">
	{
		!isLoggedIn ? (
			<AccessGate
				badge="Login required"
				title="Sign in to view subscriptions"
				description="Admin workspaces are available after you sign in."
			/>
		) : !isAdmin ? (
			<AccessGate
				badge="Admin only"
				title="Admin access required"
				description="Only workspace admins can manage subscription records."
				linkHref="/profile"
				linkText="Go to profile"
				hint="Request admin access from your workspace owner if you need to edit subscriptions."
			/>
		) : (
			<div class="p-6 lg:p-8">
				<AdminPageHeader eyebrow="Subscription management" title="Subscriptions">
					<Fragment slot="actions">
						<a href="/admin/subscriptions/new" class="btn btn-primary btn-sm">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
							</svg>
							New
						</a>
					</Fragment>
				</AdminPageHeader>

				{error && (
					<div class="alert alert-warning mb-6 max-w-5xl">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
						</svg>
						<span>{error}</span>
					</div>
				)}

				<!-- Subscriptions list -->
				<div class="max-w-5xl">
					<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden" x-data="{ search: '', subscriptions: [], get filteredSubs() { return this.subscriptions.filter(s => s.customer.toLowerCase().includes(this.search.toLowerCase()) || s.id.toLowerCase().includes(this.search.toLowerCase())) } }" x-init={`subscriptions = ${JSON.stringify(subscriptions)}`}>
						<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40 flex items-center justify-between gap-4">
							<div>
								<h3 class="font-display text-lg">All Subscriptions</h3>
								<p class="text-xs text-base-content/60 mt-0.5">Click on a subscription to view details</p>
							</div>
							<label class="input input-bordered flex items-center gap-2 bg-base-100/80 w-64">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
									<path stroke-linecap="round" stroke-linejoin="round" d="m21 21-4.35-4.35m1.35-5.65a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z" />
								</svg>
								<input type="text" class="grow bg-transparent" placeholder="Search subscriptions..." x-model="search" />
							</label>
						</div>
						<div class="overflow-x-auto">
							<table class="table">
								<thead>
									<tr class="text-xs uppercase tracking-widest text-base-content/50 border-b border-base-300/60">
										<th class="font-medium">Subscription #</th>
										<th class="font-medium">Customer</th>
										<th class="font-medium">Status</th>
										<th class="font-medium">Recurring Plan</th>
										<th class="font-medium">Expiration</th>
										<th class="font-medium text-right">Amount</th>
										<th class="w-16"></th>
									</tr>
								</thead>
								<tbody>
									<template x-if="filteredSubs.length > 0">
										<template x-for="sub in filteredSubs" :key="sub.dbId">
											<tr class="hover:bg-base-200/40 transition-colors cursor-pointer border-b border-base-300/40" @click="window.location.href = `/admin/subscriptions/${sub.dbId}`">
												<td class="font-medium text-primary" x-text="sub.id"></td>
												<td x-text="sub.customer"></td>
												<td>
													<span class="badge badge-sm" 
														:class="sub.status === 'Quotation' ? 'badge-warning badge-outline' : sub.status === 'Quotation Sent' ? 'badge-info badge-outline' : sub.status === 'Confirmed' || sub.status === 'Active' ? 'badge-success' : sub.status === 'Closed' ? 'badge-neutral' : sub.status === 'Cancelled' ? 'badge-error badge-outline' : sub.status === 'Expired' ? 'badge-error' : 'badge-ghost'"
														x-text="sub.status"></span>
												</td>
												<td x-text="sub.plan"></td>
												<td class="text-base-content/70" x-text="sub.expiration"></td>
												<td class="text-right font-mono text-sm">$<span x-text="sub.amount.toLocaleString()"></span></td>
												<td>
													<a :href="`/admin/subscriptions/${sub.dbId}`" class="btn btn-ghost btn-xs" @click.stop>
														<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
															<path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
														</svg>
													</a>
												</td>
											</tr>
										</template>
									</template>
									<template x-if="filteredSubs.length === 0">
										<tr>
											<td colspan="7" class="text-center py-12 text-base-content/50">
												<div class="flex flex-col items-center gap-3">
													<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
														<path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
													</svg>
													<p x-text="search ? 'No subscriptions match your search' : 'No subscriptions yet'"></p>
												</div>
											</td>
										</tr>
									</template>
								</tbody>
							</table>
						</div>
						<div class="px-5 py-3 border-t border-base-300/60 bg-base-100/40 flex items-center justify-between">
							<span class="text-xs text-base-content/50"><span x-text="filteredSubs.length"></span> subscriptions</span>
						</div>
					</div>
				</div>
			</div>
		)
	}
</AdminLayout>
