---
export const prerender = false;
import Layout from '../layouts/Layout.astro';
import jwt from 'jsonwebtoken';
import { SESSION_COOKIE_NAME } from '../lib/auth.js';

const session = Astro.locals?.session ?? {};
if (session.isLoggedIn) {
	return Astro.redirect(session.isAdmin ? '/admin/subscriptions' : '/shop');
}

const formValues = {
	email: ''
};

const formErrors = {
	email: '',
	password: ''
};

let backendError = '';

const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
const hasUppercase = (value) => /[A-Z]/.test(value);
const hasLowercase = (value) => /[a-z]/.test(value);
const hasSpecial = (value) => /[^A-Za-z0-9]/.test(value);

if (Astro.request.method === 'POST') {
	const contentType = Astro.request.headers.get('content-type') ?? '';
	let email = '';
	let password = '';

	if (contentType.includes('application/json')) {
		const body = await Astro.request.json().catch(() => ({}));
		email = String(body?.email ?? '').trim();
		password = String(body?.password ?? '');
	} else if (
		contentType.includes('application/x-www-form-urlencoded') ||
		contentType.includes('multipart/form-data')
	) {
		const formData = await Astro.request.formData();
		email = String(formData.get('email') ?? '').trim();
		password = String(formData.get('password') ?? '');
	} else {
		backendError = 'Unsupported login request content type.';
		Astro.response.status = 415;
	}

	formValues.email = email;

	if (!email) {
		formErrors.email = 'Email is required.';
	} else if (!emailRegex.test(email)) {
		formErrors.email = 'Enter a valid email address.';
	}

	if (!password) {
		formErrors.password = 'Password is required.';
	} else if (password.length < 9) {
		formErrors.password = 'Password must be at least 9 characters long.';
	} else if (!hasUppercase(password) || !hasLowercase(password) || !hasSpecial(password)) {
		formErrors.password = 'Password must include uppercase, lowercase, and a special character.';
	}

	const hasErrors = Boolean(formErrors.email || formErrors.password);

	if (!hasErrors) {
		try {
			const response = await fetch('http://localhost:3000/auth/login', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ email, password })
			});

			const data = await response.json().catch(() => ({}));

			if (!response.ok) {
				backendError = data?.error ?? 'Login failed.';
				Astro.response.status = response.status;
			} else {
				const token = data?.token;
				if (!token) {
					backendError = 'Login token not received.';
					Astro.response.status = 401;
				} else {
					const payload = jwt.decode(token);
					const adminEmail = process.env.ADMIN_EMAIL?.toLowerCase();
					const tokenEmail = String(payload?.email ?? '').toLowerCase();
					const isAdmin = Boolean(adminEmail && tokenEmail && tokenEmail === adminEmail);

					Astro.cookies.set(
						SESSION_COOKIE_NAME,
						JSON.stringify({ token }),
						{
							path: '/',
							httpOnly: true,
							sameSite: 'lax',
							secure: import.meta.env.PROD,
							maxAge: 60 * 60
						}
					);

					return Astro.redirect(isAdmin ? '/admin/subscriptions' : '/shop');
				}
			}
		} catch {
			backendError = 'Unable to reach the login service.';
			Astro.response.status = 502;
		}
	}
}
---

<Layout title="TinkerTrack • Login">
	<main>
		<section class="relative flex-1 overflow-hidden">
			<div class="pointer-events-none absolute inset-0">
				<div
					class="absolute -top-20 left-10 h-64 w-64 rounded-full bg-primary/25 blur-3xl"
				></div>
				<div
					class="absolute bottom-0 right-0 h-80 w-80 rounded-full bg-secondary/20 blur-3xl"
				></div>
			</div>

			<div class="mx-auto grid max-w-6xl gap-10 px-6 py-16 lg:grid-cols-2 lg:items-center">
				<div class="flex flex-col items-center text-center lg:items-start lg:text-left">
					<p class="badge badge-outline">Workspace access</p>
					<h1 class="font-display mt-4 text-4xl font-semibold tracking-tight sm:text-5xl">
						Return to subscription control
					</h1>
					<p class="mt-4 text-base-content/70">
						Access billing plans, invoices, and renewals in one unified dashboard for
						your subscription operations.
					</p>
					<div class="mt-8 grid w-full gap-4 sm:max-w-md">
						<div class="flex items-center gap-3 text-sm text-base-content/70">
							<span class="badge badge-neutral">Billing</span>
							<span>Monitor recurring revenue and upcoming renewals.</span>
						</div>
						<div class="flex items-center gap-3 text-sm text-base-content/70">
							<span class="badge badge-neutral">Invoices</span>
							<span>Track payments, discounts, and tax summaries.</span>
						</div>
					</div>
				</div>

				<div class="mx-auto w-full max-w-md">
					<div class="card bg-base-200/70 shadow-2xl backdrop-blur">
						<div class="card-body">
							<h2 class="font-display text-2xl">Sign in to TinkerTrack</h2>
							<p class="text-sm text-base-content/70">
								Continue managing subscriptions, billing, and customer lifecycle.
							</p>
							<form class="mt-6 grid gap-5" action="/login" method="post" novalidate>
								{backendError && (
									<div class="alert alert-error text-sm">
										<span>{backendError}</span>
									</div>
								)}
								<div class="form-control">
									<label class="label">
										<span class="label-text">Email address</span>
									</label>
									<input
										type="email"
										placeholder="you@track.app"
										class="input input-bordered w-full"
										name="email"
										required
										value={formValues.email}
										aria-invalid={formErrors.email ? 'true' : 'false'}
									/>
									{formErrors.email && (
										<p class="mt-2 text-xs text-error">{formErrors.email}</p>
									)}
								</div>
								<div class="form-control">
									<label class="label">
										<span class="label-text">Password</span>
										<a class="link link-primary text-xs" href="/forgot-password">Forgot password?</a>
									</label>
									<input
										type="password"
										placeholder="••••••••"
										class="input input-bordered w-full"
										name="password"
										required
										minlength="9"
										pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*[^A-Za-z0-9]).{9,}"
										title="At least 9 characters with uppercase, lowercase, and a special character."
										aria-invalid={formErrors.password ? 'true' : 'false'}
									/>
									{formErrors.password ? (
										<p class="mt-2 text-xs text-error">{formErrors.password}</p>
									) : (
										<p class="mt-2 text-xs text-base-content/60">
											Minimum 9 characters with uppercase, lowercase, and a special character.
										</p>
									)}
								</div>
								<button class="btn btn-primary" type="submit">Sign in</button>
							</form>
							<div class="divider">Or</div>
							<button class="btn btn-outline">Continue with Google</button>
							<p class="mt-4 text-sm text-base-content/70">
								No account yet? <a class="link-hover" href="/register">Create one</a>
							</p>
						</div>
					</div>
				</div>
			</div>
		</section>
	</main>
</Layout>
