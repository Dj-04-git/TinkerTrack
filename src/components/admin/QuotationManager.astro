---
/**
 * QuotationManager Component
 * Allows creating multiple quotations for a subscription
 * Features: add/remove quotations, send for review, confirm directly
 */
---

<div class="rounded-2xl border border-base-300/70 bg-base-100/60 overflow-hidden" x-data="quotationManager()">
	<div class="px-5 py-4 border-b border-base-300/60 bg-base-100/40 flex items-center justify-between">
		<div>
			<h3 class="font-display text-lg">Quotations</h3>
			<p class="text-xs text-base-content/60 mt-0.5">Create and manage quotations for this subscription</p>
		</div>
		<button @click="addQuotation()" class="btn btn-ghost btn-sm text-primary">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
				<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
			</svg>
			Add Quotation
		</button>
	</div>

	<!-- Empty state -->
	<template x-if="quotations.length === 0">
		<div class="p-8 text-center">
			<div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-base-200/60 mb-3">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
					<path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
				</svg>
			</div>
			<p class="text-base-content/60 text-sm">No quotations yet</p>
			<p class="text-base-content/40 text-xs mt-1">Add a quotation to send to the customer for review</p>
		</div>
	</template>

	<!-- Quotation List -->
	<div class="divide-y divide-base-300/40">
		<template x-for="(quotation, qIndex) in quotations" :key="quotation.id">
			<div class="p-5">
				<!-- Quotation Header -->
				<div class="flex items-start justify-between mb-4">
					<div class="flex items-center gap-3">
						<span class="badge badge-outline" x-text="'Q' + (qIndex + 1)"></span>
						<input 
							type="text" 
							x-model="quotation.name" 
							class="input input-bordered input-sm bg-base-100/80 w-64"
							placeholder="Quotation name..."
						/>
						<span 
							class="badge text-xs"
							:class="{
								'badge-warning': quotation.status === 'draft',
								'badge-info': quotation.status === 'sent',
								'badge-success': quotation.status === 'confirmed',
								'badge-error': quotation.status === 'rejected'
							}"
							x-text="quotation.status"
						></span>
					</div>
					<div class="flex items-center gap-2">
						<!-- Action buttons based on status -->
						<template x-if="quotation.status === 'draft'">
							<div class="flex items-center gap-2">
								<button 
									@click="sendForReview(qIndex)" 
									class="btn btn-outline btn-xs"
									title="Send to customer/manager for review"
								>
									<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
										<path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
									</svg>
									Send for Review
								</button>
								<button 
									@click="confirmQuotation(qIndex)" 
									class="btn btn-primary btn-xs"
									title="Directly confirm this quotation"
								>
									<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
										<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
									</svg>
									Confirm
								</button>
							</div>
						</template>
						<template x-if="quotation.status === 'sent'">
							<div class="flex items-center gap-2">
								<span class="text-xs text-base-content/50">Awaiting response</span>
								<button 
									@click="confirmQuotation(qIndex)" 
									class="btn btn-primary btn-xs"
								>
									Confirm
								</button>
							</div>
						</template>
						<button 
							@click="removeQuotation(qIndex)" 
							class="btn btn-ghost btn-xs text-error"
							:disabled="quotation.status === 'confirmed'"
							title="Remove quotation"
						>
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
							</svg>
						</button>
					</div>
				</div>

				<!-- Quotation Details -->
				<div class="grid gap-4 sm:grid-cols-3 mb-4">
					<label class="form-control">
						<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Validity (days)</span>
						<input 
							type="number" 
							min="1" 
							x-model.number="quotation.validityDays" 
							class="input input-bordered input-sm bg-base-100/80"
							:disabled="quotation.status !== 'draft'"
						/>
					</label>
					<label class="form-control">
						<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Reviewer Email</span>
						<input 
							type="email" 
							x-model="quotation.reviewerEmail" 
							placeholder="customer@example.com"
							class="input input-bordered input-sm bg-base-100/80"
							:disabled="quotation.status !== 'draft'"
						/>
					</label>
					<label class="form-control">
						<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Expires On</span>
						<input 
							type="date" 
							x-model="quotation.expiresOn" 
							class="input input-bordered input-sm bg-base-100/80"
							:disabled="quotation.status !== 'draft'"
						/>
					</label>
				</div>

				<!-- Product Lines for this quotation -->
				<div class="rounded-xl border border-base-300/50 bg-base-200/30 overflow-hidden">
					<div class="px-4 py-3 border-b border-base-300/40 bg-base-100/30 flex items-center justify-between">
						<span class="text-sm font-medium text-base-content/70">Line Items</span>
						<button 
							@click="addLineToQuotation(qIndex)" 
							class="btn btn-ghost btn-xs text-primary"
							:disabled="quotation.status !== 'draft'"
						>
							<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
								<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
							</svg>
							Add Line
						</button>
					</div>
					<div class="overflow-x-auto">
						<table class="table table-sm">
							<thead>
								<tr class="text-xs uppercase tracking-widest text-base-content/50 border-b border-base-300/40">
									<th class="font-medium">Product</th>
									<th class="font-medium text-center">Qty</th>
									<th class="font-medium text-right">Unit Price</th>
									<th class="font-medium text-right">Amount</th>
									<th class="w-12"></th>
								</tr>
							</thead>
							<tbody>
								<template x-if="quotation.lines.length === 0">
									<tr>
										<td colspan="5" class="text-center py-4 text-base-content/40 text-sm">
											No items added yet
										</td>
									</tr>
								</template>
								<template x-for="(line, lIndex) in quotation.lines" :key="lIndex">
									<tr class="border-b border-base-300/30 hover:bg-base-200/40">
										<td>
											<template x-if="quotation.status === 'draft'">
												<select 
													x-model="line.product" 
													@change="updateLinePrice(qIndex, lIndex)"
													class="select select-bordered select-xs bg-base-100/80 w-full"
												>
													<option value="">Select product...</option>
													<template x-for="p in products" :key="p.name">
														<option :value="p.name" x-text="p.name"></option>
													</template>
												</select>
											</template>
											<template x-if="quotation.status !== 'draft'">
												<span x-text="line.product" class="font-medium"></span>
											</template>
										</td>
										<td class="text-center">
											<template x-if="quotation.status === 'draft'">
												<input 
													type="number" 
													min="1" 
													x-model.number="line.quantity" 
													class="input input-bordered input-xs bg-base-100/80 w-16 text-center"
												/>
											</template>
											<template x-if="quotation.status !== 'draft'">
												<span x-text="line.quantity"></span>
											</template>
										</td>
										<td class="text-right">
											<template x-if="quotation.status === 'draft'">
												<input 
													type="number" 
													step="0.01" 
													x-model.number="line.unitPrice" 
													class="input input-bordered input-xs bg-base-100/80 w-24 text-right"
												/>
											</template>
											<template x-if="quotation.status !== 'draft'">
												<span class="font-mono text-sm" x-text="'$' + line.unitPrice.toLocaleString()"></span>
											</template>
										</td>
										<td class="text-right font-mono text-sm" x-text="'$' + (line.quantity * line.unitPrice).toLocaleString()"></td>
										<td>
											<template x-if="quotation.status === 'draft'">
												<button @click="removeLineFromQuotation(qIndex, lIndex)" class="btn btn-ghost btn-xs text-error">
													<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
														<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
													</svg>
												</button>
											</template>
										</td>
									</tr>
								</template>
							</tbody>
							<tfoot class="bg-base-100/30">
								<tr class="border-t border-base-300/50">
									<td colspan="3" class="text-right font-medium text-base-content/70">Total</td>
									<td class="text-right font-mono font-bold" x-text="'$' + getQuotationTotal(qIndex).toLocaleString()"></td>
									<td></td>
								</tr>
							</tfoot>
						</table>
					</div>
				</div>

				<!-- Notes -->
				<div class="mt-4">
					<label class="form-control">
						<span class="label-text text-xs uppercase tracking-widest text-base-content/60">Notes</span>
						<textarea 
							x-model="quotation.notes" 
							class="textarea textarea-bordered textarea-sm bg-base-100/80 h-20"
							placeholder="Add any notes for this quotation..."
							:disabled="quotation.status !== 'draft'"
						></textarea>
					</label>
				</div>
			</div>
		</template>
	</div>

	<!-- Summary Footer -->
	<template x-if="quotations.length > 0">
		<div class="px-5 py-3 border-t border-base-300/60 bg-base-100/40 flex items-center justify-between">
			<span class="text-xs text-base-content/50">
				<span x-text="quotations.length"></span> quotation(s) â€¢ 
				<span x-text="quotations.filter(q => q.status === 'confirmed').length"></span> confirmed
			</span>
			<span class="font-display text-sm">
				Total Value: <span class="font-mono font-bold" x-text="'$' + getAllQuotationsTotal().toLocaleString()"></span>
			</span>
		</div>
	</template>
</div>

<!-- Send for Review Modal -->
<dialog id="sendReviewModal" class="modal">
	<div class="modal-box">
		<h3 class="font-display text-lg font-semibold">Send Quotation for Review</h3>
		<p class="py-4 text-base-content/70">
			This will send the quotation to the specified reviewer email for approval. 
			They will receive a link to review and approve or reject the quotation.
		</p>
		<div class="form-control mb-4">
			<label class="label">
				<span class="label-text">Reviewer Email</span>
			</label>
			<input type="email" id="reviewerEmailInput" class="input input-bordered" placeholder="customer@example.com" />
		</div>
		<div class="modal-action">
			<form method="dialog">
				<button class="btn btn-ghost">Cancel</button>
			</form>
			<button id="confirmSendReview" class="btn btn-primary">Send</button>
		</div>
	</div>
	<form method="dialog" class="modal-backdrop">
		<button>close</button>
	</form>
</dialog>

<script>
	document.addEventListener('alpine:init', () => {
		Alpine.data('quotationManager', () => ({
			quotations: [],
			products: [
				{ name: 'Pulse Analytics Suite', price: 2400 },
				{ name: 'Retention Lab', price: 980 },
				{ name: 'Design Toolkit', price: 800 },
				{ name: 'Enterprise Platform', price: 24000 },
				{ name: 'Priority Support', price: 4800 }
			],
			nextId: 1,

			addQuotation() {
				const defaultExpiry = new Date();
				defaultExpiry.setDate(defaultExpiry.getDate() + 14);
				
				this.quotations.push({
					id: this.nextId++,
					name: `Quotation ${this.quotations.length + 1}`,
					status: 'draft',
					validityDays: 14,
					reviewerEmail: '',
					expiresOn: defaultExpiry.toISOString().split('T')[0],
					notes: '',
					lines: []
				});
			},

			removeQuotation(index) {
				if (this.quotations[index].status === 'confirmed') return;
				this.quotations.splice(index, 1);
			},

			addLineToQuotation(qIndex) {
				this.quotations[qIndex].lines.push({
					product: '',
					quantity: 1,
					unitPrice: 0
				});
			},

			removeLineFromQuotation(qIndex, lIndex) {
				this.quotations[qIndex].lines.splice(lIndex, 1);
			},

			updateLinePrice(qIndex, lIndex) {
				const line = this.quotations[qIndex].lines[lIndex];
				const product = this.products.find(p => p.name === line.product);
				if (product) {
					line.unitPrice = product.price;
				}
			},

			getQuotationTotal(qIndex) {
				return this.quotations[qIndex].lines.reduce((sum, line) => {
					return sum + (line.quantity * line.unitPrice);
				}, 0);
			},

			getAllQuotationsTotal() {
				return this.quotations.reduce((sum, q, qIndex) => {
					return sum + this.getQuotationTotal(qIndex);
				}, 0);
			},

			sendForReview(qIndex) {
				const quotation = this.quotations[qIndex];
				if (!quotation.reviewerEmail) {
					alert('Please enter a reviewer email first');
					return;
				}
				// In real implementation, this would call an API
				quotation.status = 'sent';
				this.showToast(`Quotation sent to ${quotation.reviewerEmail}`);
			},

			confirmQuotation(qIndex) {
				this.quotations[qIndex].status = 'confirmed';
				this.showToast('Quotation confirmed!');
			},

			showToast(message) {
				const toast = document.createElement('div');
				toast.className = 'toast toast-end toast-bottom z-50';
				toast.innerHTML = `
					<div class="alert alert-success shadow-lg">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
						</svg>
						<span>${message}</span>
					</div>
				`;
				document.body.appendChild(toast);
				setTimeout(() => toast.remove(), 3000);
			}
		}));
	});
</script>
